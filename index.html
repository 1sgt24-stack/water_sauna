<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‚¬ìš°ë‚˜ ë¹„í’ˆ ì¬ê³  ê´€ë¦¬</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#22263a;--surface3:#2a2f45;
  --border:#2e3348;--accent:#4f8ef7;--accent2:#7c5cfc;
  --green:#22c55e;--yellow:#f59e0b;--red:#ef4444;
  --purple:#a78bfa;--teal:#2dd4bf;--orange:#fb923c;
  --text:#e2e8f0;--text2:#8892a4;--text3:#5a6478;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* HEADER */
.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;gap:12px;height:60px;position:sticky;top:0;z-index:100;}
.hdr-logo{font-size:18px;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hdr-sub{font-size:11px;color:var(--text3);font-family:'IBM Plex Mono',monospace;}
.hdr-reset{margin-left:auto;background:transparent;border:1px solid var(--border);color:var(--text3);padding:4px 10px;border-radius:6px;font-size:11px;cursor:pointer;font-family:'Noto Sans KR',sans-serif;}
.hdr-reset:hover{border-color:var(--red);color:var(--red);}

/* TABS */
.tabs{background:var(--surface);border-bottom:1px solid var(--border);display:flex;padding:0 24px;overflow-x:auto;}
.tab{padding:12px 18px;font-size:13px;font-weight:500;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all .15s;display:flex;align-items:center;gap:5px;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}

/* LAYOUT */
.content{padding:24px;max-width:1500px;margin:0 auto;}
.page{display:none;}.page.active{display:block;}

/* STAT CARDS */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:24px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;position:relative;overflow:hidden;transition:border-color .2s;}
.stat-card:hover{border-color:var(--accent);}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--cc,var(--accent));}
.stat-lbl{font-size:11px;color:var(--text3);font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;}
.stat-val{font-size:30px;font-weight:900;line-height:1;margin-bottom:3px;}
.stat-sub{font-size:11px;color:var(--text2);}

/* BUY CARDS */
.buy-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:26px;}
.buy-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;flex-direction:column;gap:7px;}
.buy-card.urgent{border-color:rgba(239,68,68,.5);background:rgba(239,68,68,.04);}
.buy-card.caution{border-color:rgba(245,158,11,.5);background:rgba(245,158,11,.04);}
.buy-card.ok{border-color:rgba(34,197,94,.4);}
.buy-type-tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;display:inline-block;margin-bottom:2px;}
.tag-equip{background:rgba(79,142,247,.15);color:var(--accent);}
.tag-consumable{background:rgba(251,146,60,.15);color:var(--orange);}
.buy-cname{font-size:13px;font-weight:700;}
.buy-row{display:flex;justify-content:space-between;font-size:12px;color:var(--text2);}
.buy-row span:last-child{font-weight:600;font-family:'IBM Plex Mono',monospace;}
.buy-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
.buy-bar-fill{height:100%;border-radius:2px;}
.buy-need{font-size:18px;font-weight:900;}

/* SECTION */
.sec{font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.sec::after{content:'';flex:1;height:1px;background:var(--border);}

/* TABLE */
.twrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:22px;}
.thead-row{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
.ttitle{font-size:14px;font-weight:700;display:flex;align-items:center;gap:7px;}
.tctrls{display:flex;gap:7px;align-items:center;flex-wrap:wrap;}
.si{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:6px 11px;font-size:13px;color:var(--text);font-family:'Noto Sans KR',sans-serif;outline:none;transition:border-color .2s;width:170px;}
.si:focus{border-color:var(--accent);}
.si::placeholder{color:var(--text3);}
.fsel{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:13px;color:var(--text);font-family:'Noto Sans KR',sans-serif;outline:none;cursor:pointer;}
.fsel option{background:var(--surface);}

table{width:100%;border-collapse:collapse;}
thead th{padding:9px 14px;font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;text-align:left;background:var(--surface2);border-bottom:1px solid var(--border);}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:var(--surface2);}
tbody td{padding:11px 14px;font-size:13px;vertical-align:middle;}
.tr-consumable td:first-child{border-left:3px solid var(--orange);}
.tr-equip td:first-child{border-left:3px solid var(--accent);}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius:20px;font-size:11px;font-weight:600;}
.b-ok{background:rgba(34,197,94,.15);color:var(--green);}
.b-warn{background:rgba(245,158,11,.15);color:var(--yellow);}
.b-danger{background:rgba(239,68,68,.15);color:var(--red);}
.b-info{background:rgba(79,142,247,.15);color:var(--accent);}
.b-purple{background:rgba(167,139,250,.15);color:var(--purple);}
.b-gray{background:rgba(90,100,120,.25);color:var(--text3);}
.b-orange{background:rgba(251,146,60,.15);color:var(--orange);}

/* BUTTONS */
.btn{padding:6px 13px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:'Noto Sans KR',sans-serif;transition:all .15s;display:inline-flex;align-items:center;gap:5px;}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:#3a7af0;}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border);}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
.btn-danger{background:transparent;color:var(--red);border:1px solid var(--red);}
.btn-danger:hover{background:var(--red);color:#fff;}
.btn-orange{background:rgba(251,146,60,.12);color:var(--orange);border:1px solid rgba(251,146,60,.3);}
.btn-orange:hover{background:var(--orange);color:#fff;}
.btn-purple{background:rgba(167,139,250,.12);color:var(--purple);border:1px solid rgba(167,139,250,.3);}
.btn-purple:hover{background:var(--purple);color:#fff;}
.btn-sm{padding:3px 9px;font-size:12px;}

/* PROGRESS */
.pbar{height:5px;background:var(--border);border-radius:3px;overflow:hidden;width:70px;display:inline-block;vertical-align:middle;margin-right:7px;}
.pbar-fill{height:100%;border-radius:3px;}

/* MODAL */
.moverlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;padding:16px;}
.moverlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:580px;transform:translateY(20px);transition:transform .2s;max-height:92vh;overflow-y:auto;}
.moverlay.open .modal{transform:translateY(0);}
.mhead{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;}
.mtitle{font-size:16px;font-weight:700;}
.mbody{padding:18px 22px;}
.mfoot{padding:14px 22px 18px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border);}
.xbtn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:18px;padding:3px;border-radius:6px;}
.xbtn:hover{background:var(--border);color:var(--text);}

/* FORM */
.fg{margin-bottom:14px;}
.fl{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:5px;display:block;}
.fi,.fse,.fta{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:9px 11px;font-size:14px;color:var(--text);font-family:'Noto Sans KR',sans-serif;outline:none;transition:border-color .2s;}
.fi:focus,.fse:focus,.fta:focus{border-color:var(--accent);}
.fse option{background:var(--surface);}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:11px;}
.frow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:11px;}
.fta{resize:vertical;min-height:52px;}

/* TYPE TOGGLE */
.type-toggle{display:flex;gap:8px;margin-bottom:16px;}
.type-btn{flex:1;padding:10px;border-radius:10px;border:2px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-size:13px;font-weight:600;font-family:'Noto Sans KR',sans-serif;text-align:center;transition:all .15s;}
.type-btn.active-equip{border-color:var(--accent);background:rgba(79,142,247,.1);color:var(--accent);}
.type-btn.active-consumable{border-color:var(--orange);background:rgba(251,146,60,.1);color:var(--orange);}

/* CONSUMABLE INOUT MODAL */
.inout-tabs{display:flex;gap:0;border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:16px;}
.inout-tab{flex:1;padding:8px;text-align:center;font-size:13px;font-weight:600;cursor:pointer;background:var(--surface2);color:var(--text2);border:none;font-family:'Noto Sans KR',sans-serif;transition:all .15s;}
.inout-tab.active-in{background:rgba(34,197,94,.15);color:var(--green);}
.inout-tab.active-out{background:rgba(239,68,68,.15);color:var(--red);}

/* EQUIP INLINE */
.editable-cell{cursor:pointer;border-radius:4px;padding:2px 5px;transition:background .15s;display:inline-block;}
.editable-cell:hover{background:var(--surface3);}
.inline-input{background:var(--bg);border:1px solid var(--accent);border-radius:6px;padding:3px 8px;font-size:13px;color:var(--text);font-family:'Noto Sans KR',sans-serif;outline:none;width:100%;min-width:80px;}
.inline-select{background:var(--bg);border:1px solid var(--accent);border-radius:6px;padding:3px 8px;font-size:13px;color:var(--text);font-family:'Noto Sans KR',sans-serif;outline:none;}
.inline-select option{background:var(--surface);}

/* STOCK LOG */
.log-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);align-items:flex-start;}
.log-item:last-child{border-bottom:none;}
.log-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0;}

/* CAT PILLS */
.cat-nav{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;}
.cat-pill{padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2);transition:all .15s;display:flex;align-items:center;gap:5px;}
.cat-pill:hover{border-color:var(--accent);color:var(--accent);}
.cat-pill.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.cat-pill .cnt{background:rgba(255,255,255,.2);padding:1px 6px;border-radius:10px;font-size:11px;}
.cat-pill:not(.active) .cnt{background:var(--surface2);color:var(--text3);}

/* EQUIP TABLE */
.equip-detail-table{width:100%;border-collapse:collapse;}
.equip-detail-table thead th{padding:9px 14px;font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;text-align:left;background:var(--surface2);border-bottom:1px solid var(--border);}
.equip-detail-table tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
.equip-detail-table tbody tr:last-child{border-bottom:none;}
.equip-detail-table tbody tr:hover{background:var(--surface2);}
.equip-detail-table tbody td{padding:11px 14px;font-size:13px;vertical-align:middle;}

.mth{display:inline-block;padding:2px 7px;border-radius:4px;font-size:11px;font-family:'IBM Plex Mono',monospace;font-weight:600;}
.mth-buy{background:rgba(79,142,247,.12);color:var(--accent);}
.mth-disc{background:rgba(239,68,68,.12);color:var(--red);}
.alert-bar{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:10px;padding:11px 15px;margin-bottom:18px;display:flex;align-items:center;gap:9px;font-size:13px;color:var(--yellow);}
.empty-st{padding:44px;text-align:center;color:var(--text3);}
.mono{font-family:'IBM Plex Mono',monospace;}
.divider{height:1px;background:var(--border);margin:14px 0;}
.info-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;font-size:12px;color:var(--text2);margin-bottom:14px;line-height:1.7;}

.toast-wrap{position:fixed;bottom:22px;right:22px;z-index:300;display:flex;flex-direction:column;gap:7px;}
.toast{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px 15px;font-size:13px;box-shadow:0 8px 24px rgba(0,0,0,.4);animation:sIn .2s ease;display:flex;align-items:center;gap:7px;}
@keyframes sIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* â”€â”€ ANALYTICS â”€â”€ */
.an-chart-wrap{display:grid;grid-template-columns:1fr;gap:16px;}
.chart-legend{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px;}
.legend-item{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text2);}
.legend-dot{width:10px;height:10px;border-radius:50%;}
/* mini bar chart */
.bar-chart{display:flex;align-items:flex-end;gap:6px;height:160px;padding-bottom:24px;position:relative;margin-top:8px;overflow-x:auto;}
.bar-col{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:52px;}
.bar-stack{display:flex;flex-direction:column;align-items:center;justify-content:flex-end;width:32px;position:relative;}
.bar-seg{width:100%;border-radius:3px 3px 0 0;transition:height .3s;}
.bar-lbl{font-size:10px;color:var(--text3);font-family:'IBM Plex Mono',monospace;white-space:nowrap;}
.bar-val{font-size:10px;font-weight:700;position:absolute;top:-16px;left:50%;transform:translateX(-50%);white-space:nowrap;}
/* sparkline */
.sparkline-wrap{width:100%;overflow-x:auto;}
.an-table-row-visitor{background:rgba(45,212,191,.04);border-left:3px solid var(--teal);}
.an-table-row-total{background:rgba(79,142,247,.04);font-weight:700;}
/* heatmap cell */
.heat-cell{padding:6px 10px;border-radius:4px;font-size:12px;font-weight:600;font-family:'IBM Plex Mono',monospace;text-align:center;}
.accuracy-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:3px;}
.accuracy-fill{height:100%;border-radius:3px;background:var(--green);}

@media(max-width:600px){
  .content{padding:14px;}
  .frow,.frow3{grid-template-columns:1fr;}
  .stat-grid,.buy-grid{grid-template-columns:repeat(2,1fr);}
}
@keyframes spin{to{transform:rotate(360deg)}}
.sync-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--green);margin-left:8px;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase SDK (CDN) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="hdr">
  <div class="hdr-logo">â™¨ ë¹„í’ˆê´€ë¦¬</div>
  <span class="hdr-sub">SAUNA INVENTORY SYSTEM <span class="sync-indicator" id="sync-dot" title="ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘"></span></span>
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
    <button class="hdr-reset" style="border-color:var(--teal);color:var(--teal);" onclick="document.getElementById('xlsx-file-input').click()">ğŸ“‚ ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°</button>
    <input type="file" id="xlsx-file-input" accept=".xlsx,.xls" style="display:none" onchange="importXlsx(this)">
    <button class="hdr-reset" onclick="exportCurrentData()">ğŸ’¾ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
    <button class="hdr-reset" onclick="resetAllData()">ğŸ”„ ì´ˆê¸°í™”</button>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="goTab('dashboard',this)">ğŸ  ëŒ€ì‹œë³´ë“œ</div>
  <div class="tab" onclick="goTab('items',this)">ğŸ“¦ ì¬ê³  í˜„í™©</div>
  <div class="tab" onclick="goTab('equipment',this)">ğŸ”§ ì¥ë¹„ ì´ë ¥</div>
  <div class="tab" onclick="goTab('consumable',this)">ğŸ§´ ì†Œëª¨í’ˆ ì´ë ¥</div>
  <div class="tab" onclick="goTab('manage',this)">âš™ï¸ í’ˆëª© ê´€ë¦¬</div>
  <div class="tab" onclick="goTab('analytics',this)">ğŸ“Š ë°ì´í„° ë¶„ì„</div>
</div>

<div class="content">

<!-- â•â•â• DASHBOARD â•â•â• -->
<div id="page-dashboard" class="page active">
  <div id="alert-area"></div>
  <div class="stat-grid" id="stat-cards"></div>

  <div class="sec">ğŸ”§ ì¥ë¹„ â€” ë‹¹ì›” êµ¬ë§¤ í•„ìš”</div>
  <div class="buy-grid" id="equip-buy-cards"></div>

  <div class="sec">ğŸ§´ ì†Œëª¨í’ˆ â€” ìµì›” êµ¬ë§¤ ê¶Œì¥ëŸ‰</div>
  <div class="buy-grid" id="cons-buy-cards"></div>

  <div class="sec">ì „ì²´ ì¬ê³  í˜„í™© ìš”ì•½</div>
  <div class="twrap">
    <table>
      <thead><tr>
        <th>ìœ í˜•</th><th>í’ˆëª©</th><th>í˜„ì¬ìˆ˜ëŸ‰</th><th>ê¸°ì¤€ì¬ê³ </th><th>ì›”ì†Œëª¨ëŸ‰</th><th>ìµì›”êµ¬ë§¤ê¶Œì¥</th><th>ìƒíƒœ</th>
      </tr></thead>
      <tbody id="dash-tbody"></tbody>
    </table>
  </div>
</div>

<!-- â•â•â• ITEMS â•â•â• -->
<div id="page-items" class="page">
  <div class="twrap">
    <div class="thead-row">
      <div class="ttitle">ğŸ“¦ ì „ì²´ ì¬ê³  ëª©ë¡</div>
      <div class="tctrls">
        <input class="si" type="text" placeholder="í’ˆëª© ê²€ìƒ‰..." oninput="itemSearchQ=this.value;renderItems()">
        <select class="fsel" id="item-type-filter" onchange="renderItems()">
          <option value="">ì „ì²´</option><option value="equip">ì¥ë¹„</option><option value="consumable">ì†Œëª¨í’ˆ</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="openAddItem()">ï¼‹ í’ˆëª© ì¶”ê°€</button>
      </div>
    </div>
    <table>
      <thead><tr>
        <th>ìœ í˜•</th><th>í’ˆëª©ëª…</th><th>ì¹´í…Œê³ ë¦¬</th><th>í˜„ì¬ìˆ˜ëŸ‰</th><th>ê¸°ì¤€ì¬ê³ </th><th>ì›”ì†Œëª¨ëŸ‰</th><th>ìµì›”êµ¬ë§¤</th><th>ìƒíƒœ</th><th>ì•¡ì…˜</th>
      </tr></thead>
      <tbody id="items-tbody"></tbody>
    </table>
  </div>
</div>

<!-- â•â•â• EQUIPMENT HISTORY â•â•â• -->
<div id="page-equipment" class="page">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px;">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <!-- í˜„ì¬/ì•„ì¹´ì´ë¸Œ íƒ­ -->
      <div style="display:flex;background:var(--surface2);border-radius:8px;padding:3px;gap:2px;">
        <button id="equip-tab-active" onclick="setEquipTab('active')"
          style="padding:6px 14px;border-radius:6px;border:none;font-size:12px;font-weight:600;cursor:pointer;background:var(--accent);color:#fff;font-family:'Noto Sans KR',sans-serif">
          ğŸ”§ í˜„ì¬ ì¥ë¹„
        </button>
        <button id="equip-tab-archive" onclick="setEquipTab('archive')"
          style="padding:6px 14px;border-radius:6px;border:none;font-size:12px;font-weight:600;cursor:pointer;background:transparent;color:var(--text3);font-family:'Noto Sans KR',sans-serif">
          ğŸ“¦ íê¸° ì´ë ¥
        </button>
      </div>
      <input class="si" type="text" placeholder="ë²ˆí˜¸Â·ëª¨ë¸ ê²€ìƒ‰..." oninput="equipSearch=this.value;renderEquip()">
      <select class="fsel" id="ef-status" onchange="renderEquip()">
        <option value="">ì „ì²´ ìƒíƒœ</option>
        <option>ì‚¬ìš©ì¤‘</option><option>ìˆ˜ë¦¬ì¤‘</option><option>ì—¬ë¶„</option>
      </select>
    </div>
    <button class="btn btn-purple" onclick="openAddEquip()">ï¼‹ ì¥ë¹„ ë“±ë¡</button>
  </div>
  <div class="cat-nav" id="cat-pills"></div>
  <div class="twrap" id="equip-wrap">
    <div id="equip-table-area"></div>
  </div>
</div>

<!-- â•â•â• CONSUMABLE HISTORY â•â•â• -->
<div id="page-consumable" class="page">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px;">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <input class="si" type="text" placeholder="í’ˆëª© ê²€ìƒ‰..." oninput="consSearch=this.value;renderCons()">
      <select class="fsel" id="cf-item" onchange="renderCons()">
        <option value="">ì „ì²´ í’ˆëª©</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-orange" onclick="openInOut('in')">ğŸ›’ êµ¬ë§¤ ë“±ë¡</button>
      <button class="btn btn-danger" onclick="openInOut('out')">ğŸ“¦ ì†Œëª¨ ë“±ë¡</button>
      <button class="btn btn-ghost" onclick="openBulkEntry()" style="border:1px solid var(--teal);color:var(--teal)">ğŸ“‹ ì¼ê´„ ìˆ˜ê¸°ì…ë ¥</button>
    </div>
  </div>

  <!-- ì†Œëª¨í’ˆ ì¬ê³  ì¹´ë“œ -->
  <div id="cons-summary-cards" class="buy-grid" style="margin-bottom:22px;"></div>

  <!-- ì›”ë³„ ëˆ„ê³„ í…Œì´ë¸” -->
  <div class="twrap" style="margin-bottom:18px;">
    <div class="thead-row">
      <div class="ttitle">ğŸ“Š í’ˆëª©ë³„ ì›”ê°„ ëˆ„ê³„</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <select class="fsel" id="cons-year-sel" onchange="renderCons()">
          <option value="2025">2025ë…„</option><option value="2026" selected>2026ë…„</option>
        </select>
        <span style="font-size:12px;color:var(--text3)">êµ¬ë§¤(ì´ˆë¡) Â· ì†Œëª¨(ì£¼í™©)</span>
      </div>
    </div>
    <div style="overflow-x:auto;">
      <table id="cons-monthly-table" style="min-width:900px;">
        <thead><tr id="cons-monthly-head"></tr></thead>
        <tbody id="cons-monthly-body"></tbody>
      </table>
    </div>
  </div>

  <!-- ìƒì„¸ ì´ë ¥ (ê±´ë³„) -->
  <div class="twrap">
    <div class="thead-row">
      <div class="ttitle">ğŸ§¾ êµ¬ë§¤Â·ì†Œëª¨ ìƒì„¸ ì´ë ¥</div>
      <button class="btn btn-ghost btn-sm" onclick="if(confirm('ì´ë ¥ì„ ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”?')){consLogs=[];saveData();renderCons();renderDashboard();}">ğŸ—‘ ì´ë ¥ ì´ˆê¸°í™”</button>
    </div>
    <div id="cons-log-list" style="padding:0;max-height:420px;overflow-y:auto;"></div>
  </div>
</div>

<!-- â•â•â• MANAGE â•â•â• -->
<div id="page-manage" class="page">
  <div class="twrap">
    <div class="thead-row">
      <div class="ttitle">âš™ï¸ í’ˆëª© ê´€ë¦¬</div>
      <button class="btn btn-primary" onclick="openAddItem()">ï¼‹ ìƒˆ í’ˆëª© ì¶”ê°€</button>
    </div>
    <table>
      <thead><tr><th>ìœ í˜•</th><th>í’ˆëª©ëª…</th><th>ì¹´í…Œê³ ë¦¬</th><th>í˜„ì¬ ì¬ê³ </th><th>ê¸°ì¤€ì¬ê³ </th><th>ì›”ì†Œëª¨ëŸ‰</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr></thead>
      <tbody id="manage-tbody"></tbody>
    </table>
  </div>
</div>

<!-- â•â•â• ANALYTICS â•â•â• -->
<div id="page-analytics" class="page">

  <!-- ì—°ë„/ì›” í•„í„° í—¤ë” -->
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
    <div>
      <div style="font-size:20px;font-weight:900;margin-bottom:2px;">ğŸ“Š ë°ì´í„° ë¶„ì„</div>
      <div style="font-size:12px;color:var(--text3)">ì…ì¥ê° ë°ì´í„° ê¸°ë°˜ ì†Œëª¨í’ˆÂ·ì¥ë¹„ ì†Œë¹„ íŒ¨í„´ ë¶„ì„</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <select class="fsel" id="an-year" onchange="renderAnalytics()">
        <option value="2025">2025ë…„</option>
        <option value="2026" selected>2026ë…„</option>
      </select>
      <button class="btn btn-primary btn-sm" onclick="openVisitorModal()">ğŸ“‹ ì…ì¥ê° ìˆ˜ ê¸°ì…</button>
    </div>
  </div>

  <!-- ì—°ê°„ ìš”ì•½ ìŠ¤íƒ¯ -->
  <div class="stat-grid" id="an-stat-grid" style="margin-bottom:24px;"></div>

  <!-- ì…ì¥ê° vs ì†Œëª¨í’ˆ ì›”ë³„ ë¹„êµ -->
  <div class="sec">ğŸ“… ì›”ë³„ ì…ì¥ê° & ì†Œëª¨í’ˆ ì†Œë¹„ ì¶”ì´</div>
  <div class="twrap" style="padding:20px;margin-bottom:22px;">
    <div id="an-monthly-chart"></div>
  </div>

  <!-- 1ì¸ë‹¹ ì†Œëª¨ëŸ‰ ë¶„ì„ -->
  <div class="sec">ğŸ‘¤ ì…ì¥ê° 1ì¸ë‹¹ ì†Œëª¨ëŸ‰ ë¶„ì„</div>
  <div class="twrap" style="margin-bottom:22px;">
    <div class="thead-row" style="border-radius:0">
      <div class="ttitle">í’ˆëª©ë³„ 1ì¸ë‹¹ ì†Œëª¨ëŸ‰ (ì›”í‰ê· )</div>
      <div style="font-size:12px;color:var(--text3)">ì‹¤ì  ë°ì´í„° ëˆ„ì  ì‹œ ìë™ ì •ë°€í™”</div>
    </div>
    <table>
      <thead><tr>
        <th>í’ˆëª©</th><th>ì„¤ì • 1ì¸ë‹¹ ì†Œëª¨ëŸ‰</th><th>ì‹¤ì œ 1ì¸ë‹¹ ì†Œëª¨ëŸ‰</th><th>í¸ì°¨</th><th>ì •í™•ë„</th><th>ìˆ˜ë™ ë³´ì •</th>
      </tr></thead>
      <tbody id="an-perhead-tbody"></tbody>
    </table>
  </div>

  <!-- êµ¬ë§¤ ê³„íš ê³„ì‚°ê¸° -->
  <div class="sec">ğŸ›’ ì…ì¥ê° ê¸°ë°˜ êµ¬ë§¤ëŸ‰ ê³„ì‚°ê¸°</div>
  <div class="twrap" style="margin-bottom:22px;">
    <div class="thead-row" style="border-radius:0">
      <div class="ttitle" id="an-next-month-title">êµ¬ë§¤ëŸ‰ ê³„ì‚°</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <span style="font-size:12px;color:var(--text3)">ğŸ“… ëŒ€ìƒ ì›”</span>
        <input type="month" id="an-target-month"
          style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:13px;color:var(--text);outline:none;"
          oninput="renderAnalytics()">
        <span style="font-size:12px;color:var(--text3)">ğŸ‘¥ ì˜ˆìƒ ì…ì¥ê°</span>
        <input type="number" id="an-next-visitors" placeholder="ì˜ˆ: 30,000" min="0"
          style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:13px;color:var(--text);width:130px;outline:none;font-family:'IBM Plex Mono',monospace;"
          oninput="renderAnalytics()">
        <span style="font-size:12px;color:var(--text3)">ëª…</span>
      </div>
    </div>
    <!-- ìë™ ì¶”ì²œ ë°°ë„ˆ -->
    <div id="an-predict-banner" style="padding:10px 16px;background:rgba(45,212,191,.07);border-bottom:1px solid var(--border);font-size:12px;color:var(--teal)"></div>
    <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
    <div id="an-predict-cards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1px;background:var(--border)"></div>
  </div>

  <!-- ì›”ë³„ ìƒì„¸ í…Œì´ë¸” -->
  <div class="sec">ğŸ“‹ ì›”ë³„ ìƒì„¸ ë°ì´í„°</div>
  <div class="twrap" style="margin-bottom:22px;">
    <div style="overflow-x:auto">
    <table>
      <thead><tr id="an-detail-head"></tr></thead>
      <tbody id="an-detail-tbody"></tbody>
    </table>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• ì¥ë¹„ ë¶„ì„ â•â•â•â•â•â•â•â•â•â• -->
  <div style="font-size:18px;font-weight:900;margin:32px 0 16px;padding-bottom:10px;border-bottom:2px solid var(--border);display:flex;align-items:center;gap:10px">
    ğŸ”§ ì¥ë¹„ í˜„í™© ë¶„ì„
    <span style="font-size:12px;font-weight:400;color:var(--text3)">equip data based</span>
  </div>

  <!-- â‘  ìƒíƒœ ì´ìƒ ì•Œë¦¼ (ìˆ¨ê¹€) -->
  <div id="equip-alert-section" style="display:none"></div>

  <!-- â‘¡ ìœ„ì¹˜ë³„ í˜„í™© -->
  <div class="sec">ğŸ“ ìœ„ì¹˜ë³„ ì¥ë¹„ í˜„í™©</div>
  <div class="twrap" style="padding:0;margin-bottom:22px;overflow-x:auto">
    <div id="an-equip-location"></div>
  </div>

  <!-- â‘¢ ë…¸í›„í™” í˜„í™© (ìˆ¨ê¹€) -->
  <div id="equip-aging-section" style="display:none">
    <div class="sec">ğŸ“… êµ¬ë§¤ ì‹œê¸°ë³„ ë…¸í›„í™” í˜„í™©</div>
    <div class="twrap" style="padding:0;margin-bottom:22px;">
      <div id="an-equip-aging"></div>
    </div>
  </div>

  <!-- â‘£ ìˆ˜ë¦¬/íê¸° ì¶”ì´ & êµì²´ ì˜ˆì¸¡ -->
  <div class="sec">ğŸ”„ ìˆ˜ë¦¬Â·íê¸° í˜„í™© & êµì²´ ì˜ˆì¸¡</div>
  <div class="twrap" style="padding:0;margin-bottom:22px;">
    <div id="an-equip-replace"></div>
  </div>

</div><!-- /page-analytics -->

</div><!-- /content -->

<!-- â•â•â• VISITOR MODAL â•â•â• -->
<div class="moverlay" id="visitor-modal">
  <div class="modal" style="max-width:520px">
    <div class="mhead">
      <div class="mtitle">ğŸ“‹ ì›”ë³„ ì…ì¥ê° ìˆ˜ ê¸°ì…</div>
      <button class="xbtn" onclick="closeM('visitor-modal')">âœ•</button>
    </div>
    <div class="mbody">
      <div class="info-box">ğŸ’¡ ì „ì›” ì‹¤ì œ ì…ì¥ê° ìˆ˜ë¥¼ ìµì›” ì´ˆì— ê¸°ì…í•˜ì„¸ìš”. ì…ì¥ê° ë°ì´í„°ê°€ ìŒ“ì´ë©´ 1ì¸ë‹¹ ì†Œëª¨ëŸ‰ê³¼ ìµì›” ì˜ˆì¸¡ì´ ìë™ìœ¼ë¡œ ì •ë°€í•´ì§‘ë‹ˆë‹¤.</div>
      <div class="fg">
        <label class="fl">ì—°ë„</label>
        <select class="fse" id="vm-year">
          <option value="2026">2026ë…„</option><option value="2025">2025ë…„</option>
        </select>
      </div>
      <div id="vm-months-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" onclick="closeM('visitor-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveVisitors()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â• ITEM MODAL â•â•â• -->
<div class="moverlay" id="item-modal">
  <div class="modal">
    <div class="mhead">
      <div class="mtitle" id="item-modal-title">í’ˆëª© ì¶”ê°€</div>
      <button class="xbtn" onclick="closeM('item-modal')">âœ•</button>
    </div>
    <div class="mbody">
      <input type="hidden" id="im-id">
      <!-- Type toggle -->
      <div class="fg">
        <label class="fl">í’ˆëª© ìœ í˜• *</label>
        <div class="type-toggle">
          <button type="button" class="type-btn active-equip" id="type-equip-btn" onclick="setItemType('equip')">ğŸ”§ ì¥ë¹„ (ë“œë¼ì´ê¸°, íƒˆìˆ˜ê¸° ë“±)</button>
          <button type="button" class="type-btn" id="type-cons-btn" onclick="setItemType('consumable')">ğŸ§´ ì†Œëª¨í’ˆ (ë°”ë””ì›Œì‹œ, ê±´ì „ì§€ ë“±)</button>
        </div>
        <input type="hidden" id="im-type" value="equip">
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">í’ˆëª©ëª… *</label><input class="fi" id="im-name" placeholder="ì˜ˆ: ëŒ€ìš©ëŸ‰ ë°”ë””ì›Œì‹œ"></div>
        <div class="fg"><label class="fl">ì¹´í…Œê³ ë¦¬</label>
          <select class="fse" id="im-cat">
            <option>ì „ê¸°ìš©í’ˆ</option><option>ìœ„ìƒìš©í’ˆ</option><option>ì†Œëª¨í’ˆ</option><option>ìˆ˜ë‚©ìš©í’ˆ</option><option>ê¸°íƒ€</option>
          </select>
        </div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">ê¸°ì¤€ ì¬ê³ ëŸ‰</label><input class="fi" type="number" id="im-min" value="10" min="0" placeholder="ìµœì†Œ ìœ ì§€ ìˆ˜ëŸ‰"></div>
        <div class="fg" id="im-monthly-grp">
          <label class="fl">ì›” ì†Œëª¨ëŸ‰ <span style="color:var(--text3);font-weight:400">(ì†Œëª¨í’ˆ ì „ìš©)</span></label>
          <input class="fi" type="number" id="im-monthly" value="0" min="0" placeholder="í•œ ë‹¬ í‰ê·  ì†Œëª¨">
        </div>
      </div>
      <!-- ì¥ë¹„: ì´ˆê¸°ìˆ˜ëŸ‰, ì†Œëª¨í’ˆ: í˜„ì¬ìˆ˜ëŸ‰ ì§ì ‘ì…ë ¥ -->
      <div id="im-equip-fields">
        <div class="info-box">ğŸ’¡ ì¥ë¹„ ìˆ˜ëŸ‰ì€ <strong>ì¥ë¹„ ì´ë ¥ íƒ­</strong>ì—ì„œ ê°œë³„ ë“±ë¡ í›„ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
      </div>
      <div id="im-cons-fields" style="display:none">
        <div class="frow">
          <div class="fg"><label class="fl">í˜„ì¬ ì¬ê³  ìˆ˜ëŸ‰</label><input class="fi" type="number" id="im-stock" value="0" min="0"></div>
          <div class="fg"><label class="fl">ë‹¨ìœ„</label><input class="fi" id="im-unit" placeholder="ì˜ˆ: ê°œ, í†µ, ë°•ìŠ¤" value="ê°œ"></div>
        </div>
      </div>
      <div class="fg"><label class="fl">ë¹„ê³ </label><textarea class="fta" id="im-note" placeholder="ë©”ëª¨..."></textarea></div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" onclick="closeM('item-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveItem()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â• QTY MODAL (ì¥ë¹„ìš©) â•â•â• -->
<div class="moverlay" id="qty-modal">
  <div class="modal" style="max-width:420px">
    <div class="mhead">
      <div class="mtitle" id="qty-modal-title">ìˆ˜ëŸ‰ ì¡°ì •</div>
      <button class="xbtn" onclick="closeM('qty-modal')">âœ•</button>
    </div>
    <div class="mbody">
      <input type="hidden" id="qa-id">
      <div class="frow">
        <div class="fg"><label class="fl">ìœ„ì¹˜</label>
          <select class="fse" id="qa-loc">
            <option value="fb1">ì—¬ì‚¬ B1</option><option value="fb2">ì—¬ì‚¬ B2</option>
            <option value="mb1">ë‚¨ì‚¬ B1</option><option value="mb2">ë‚¨ì‚¬ B2</option>
            <option value="sup">ì§€ì›íŒ€</option><option value="emp">ì§ì›ìš©</option>
            <option value="spare">ì—¬ë¶„</option><option value="repair">ìˆ˜ë¦¬ì˜ˆì •</option><option value="discard">íê¸°ì˜ˆì •</option>
          </select>
        </div>
        <div class="fg"><label class="fl">ë³€ê²½ ìœ í˜•</label>
          <select class="fse" id="qa-type">
            <option value="set">ì§ì ‘ ì„¤ì •</option><option value="add">ì¶”ê°€(+)</option><option value="sub">ì°¨ê°(-)</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">ìˆ˜ëŸ‰</label><input class="fi" type="number" id="qa-qty" value="0" min="0"></div>
      <div class="fg"><label class="fl">ì‚¬ìœ </label><textarea class="fta" id="qa-reason" placeholder="ë³€ê²½ ì‚¬ìœ ..."></textarea></div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" onclick="closeM('qty-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveQty()">ì ìš©</button>
    </div>
  </div>
</div>

<!-- â•â•â• êµ¬ë§¤/ì†Œëª¨ ë“±ë¡ MODAL â•â•â• -->
<div class="moverlay" id="inout-modal">
  <div class="modal" style="max-width:440px">
    <div class="mhead">
      <div class="mtitle" id="inout-modal-title">êµ¬ë§¤ ë“±ë¡</div>
      <button class="xbtn" onclick="closeM('inout-modal')">âœ•</button>
    </div>
    <div class="mbody">
      <div class="inout-tabs">
        <button class="inout-tab active-in" id="inout-tab-in" onclick="switchInOut('in')">ğŸ›’ êµ¬ë§¤</button>
        <button class="inout-tab" id="inout-tab-out" onclick="switchInOut('out')">ğŸ“¦ ì†Œëª¨</button>
      </div>
      <div class="fg"><label class="fl">í’ˆëª© *</label>
        <select class="fse" id="io-item"></select>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">ìˆ˜ëŸ‰ *</label><input class="fi" type="number" id="io-qty" value="1" min="1"></div>
        <div class="fg"><label class="fl">ë‚ ì§œ</label><input class="fi" type="date" id="io-date"></div>
      </div>
      <div class="fg"><label class="fl">ë©”ëª¨</label><textarea class="fta" id="io-note" placeholder="ë‚©í’ˆì²˜, ì†Œëª¨ ìœ„ì¹˜ ë“±..."></textarea></div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" onclick="closeM('inout-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" id="inout-save-btn" onclick="saveInOut()">êµ¬ë§¤ ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â• ì´ë ¥ ìˆ˜ì • MODAL â•â•â• -->
<div class="moverlay" id="log-edit-modal">
  <div class="modal" style="max-width:420px">
    <div class="mhead">
      <div class="mtitle">âœï¸ ì´ë ¥ ìˆ˜ì •</div>
      <button class="xbtn" onclick="closeM('log-edit-modal')">âœ•</button>
    </div>
    <div class="mbody">
      <input type="hidden" id="le-id">
      <div class="fg">
        <label class="fl">ìœ í˜•</label>
        <div style="display:flex;gap:8px;">
          <button type="button" id="le-type-in" class="btn btn-orange btn-sm" onclick="setLogEditType('in')">ğŸ›’ êµ¬ë§¤</button>
          <button type="button" id="le-type-out" class="btn btn-ghost btn-sm" onclick="setLogEditType('out')">ğŸ“¦ ì†Œëª¨</button>
          <input type="hidden" id="le-type" value="in">
        </div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">ìˆ˜ëŸ‰</label><input class="fi" type="number" id="le-qty" min="1"></div>
        <div class="fg"><label class="fl">ë‚ ì§œ</label><input class="fi" type="date" id="le-date"></div>
      </div>
      <div class="fg"><label class="fl">ë©”ëª¨</label><textarea class="fta" id="le-note"></textarea></div>
    </div>
    <div class="mfoot">
      <button class="btn btn-danger btn-sm" onclick="deleteLog()">ğŸ—‘ ì‚­ì œ</button>
      <div style="flex:1"></div>
      <button class="btn btn-ghost" onclick="closeM('log-edit-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveLogEdit()">ìˆ˜ì • ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â• EQUIP MODAL â•â•â• -->
<div class="moverlay" id="equip-modal">
  <div class="modal">
    <div class="mhead">
      <div class="mtitle" id="equip-modal-title">ì¥ë¹„ ë“±ë¡</div>
      <button class="xbtn" onclick="closeM('equip-modal')">âœ•</button>
    </div>
    <div class="mbody">
      <input type="hidden" id="em-id">
      <div class="frow">
        <div class="fg"><label class="fl">ë²ˆí˜¸ <span style="color:var(--text3);font-weight:400">(ì§ì ‘ ì…ë ¥)</span></label>
          <input class="fi" id="em-num" placeholder="ì˜ˆ: 001, A-01">
        </div>
        <div class="fg"><label class="fl">í’ˆëª© *</label><select class="fse" id="em-item"></select></div>
      </div>
      <div class="fg"><label class="fl">ì œì¡°ì‚¬ / ëª¨ë¸ëª…</label>
        <input class="fi" id="em-model" placeholder="ì˜ˆ: íŒŒë‚˜ì†Œë‹‰ EH-NA45">
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">êµ¬ë§¤ì›”</label><input class="fi" type="month" id="em-buy"></div>
        <div class="fg"><label class="fl">ì„¤ì¹˜ì¼</label><input class="fi" type="date" id="em-install"></div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">ì„¤ì¹˜ ìœ„ì¹˜</label>
          <select class="fse" id="em-loc">
            <option>ì—¬ì‚¬ B1</option><option>ì—¬ì‚¬ B2</option><option>ë‚¨ì‚¬ B1</option><option>ë‚¨ì‚¬ B2</option>
            <option>ì§€ì›íŒ€</option><option>ì§ì›ìš©</option><option>ì—¬ë¶„</option>
          </select>
        </div>
        <div class="fg"><label class="fl">í˜„ì¬ ìƒíƒœ</label>
          <select class="fse" id="em-status" onchange="toggleDiscardFields()">
            <option>ì‚¬ìš©ì¤‘</option><option>ìˆ˜ë¦¬ì¤‘</option><option>ì—¬ë¶„</option><option>íê¸°</option>
          </select>
        </div>
      </div>
      <div id="em-discard-grp" class="frow" style="display:none">
        <div class="fg"><label class="fl">íê¸°ì›”</label><input class="fi" type="month" id="em-dmonth"></div>
        <div class="fg"><label class="fl">íê¸° ì‚¬ìœ </label><input class="fi" id="em-dreason" placeholder="ê³ ì¥, íŒŒì† ë“±"></div>
      </div>
      <div class="fg"><label class="fl">ë©”ëª¨</label><textarea class="fta" id="em-note" placeholder="ë©”ëª¨..."></textarea></div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" onclick="closeM('equip-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveEquip()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â• ì„¸ëŒ€ êµì²´ MODAL â•â•â• -->
<div class="moverlay" id="replace-modal">
  <div class="modal" style="max-width:480px">
    <div class="mhead">
      <div class="mtitle">ğŸ”„ ì„¸ëŒ€ êµì²´ â€” ìƒˆ ì¥ë¹„ ë“±ë¡</div>
      <button class="xbtn" onclick="closeM('replace-modal')">âœ•</button>
    </div>
    <div class="mbody">
      <!-- íê¸° ì¥ë¹„ ìš”ì•½ -->
      <div id="replace-old-summary" style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:12px 14px;margin-bottom:16px;font-size:13px;"></div>
      <input type="hidden" id="rp-item-name">
      <input type="hidden" id="rp-num">
      <input type="hidden" id="rp-generation">
      <!-- ìƒˆ ì¥ë¹„ ì •ë³´ -->
      <div style="font-size:12px;font-weight:700;color:var(--teal);margin-bottom:10px;">ğŸ“¦ ìƒˆ ì¥ë¹„ ì •ë³´ ì…ë ¥</div>
      <div class="fg"><label class="fl">ì œì¡°ì‚¬ / ëª¨ë¸ëª…</label>
        <input class="fi" id="rp-model" placeholder="ì˜ˆ: íŒŒë‚˜ì†Œë‹‰ EH-NA45">
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">êµ¬ë§¤ì›” *</label><input class="fi" type="month" id="rp-buy"></div>
        <div class="fg"><label class="fl">ì„¤ì¹˜ì¼</label><input class="fi" type="date" id="rp-install"></div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">ì„¤ì¹˜ ìœ„ì¹˜</label>
          <select class="fse" id="rp-loc">
            <option>ì—¬ì‚¬ B1</option><option>ì—¬ì‚¬ B2</option><option>ë‚¨ì‚¬ B1</option><option>ë‚¨ì‚¬ B2</option>
            <option>ì§€ì›íŒ€</option><option>ì§ì›ìš©</option><option>ì—¬ë¶„</option>
          </select>
        </div>
        <div class="fg"><label class="fl">ìƒíƒœ</label>
          <select class="fse" id="rp-status">
            <option>ì‚¬ìš©ì¤‘</option><option>ì—¬ë¶„</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">ë©”ëª¨</label>
        <textarea class="fta" id="rp-note" placeholder="ë©”ëª¨..."></textarea>
      </div>
    </div>
    <div class="mfoot" style="flex-direction:column;gap:8px;align-items:stretch">
      <button class="btn btn-primary" style="width:100%" onclick="saveReplacement()">âœ… ìƒˆ ì¥ë¹„ ë“±ë¡ (ì„¸ëŒ€ êµì²´ ì™„ë£Œ)</button>
      <button class="btn btn-ghost" style="width:100%;font-size:12px" onclick="closeM('replace-modal')">ë‚˜ì¤‘ì— ë“±ë¡í•˜ê¸° (íê¸°ë§Œ ì €ì¥)</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE KEYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK_ITEMS  = 'sauna_items_v3';
const SK_EQUIPS = 'sauna_equips_v3';
const SK_CLOGS  = 'sauna_clogs_v3';   // consumable logs
const SK_CTR    = 'sauna_ctr_v3';
const SK_VISITORS = 'sauna_visitors_v1';  // ì…ì¥ê° ë°ì´í„°
const SK_PERHEAD  = 'sauna_perhead_v1';   // 1ì¸ë‹¹ ì†Œëª¨ëŸ‰ ì„¤ì •

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyABtJnwGMAhEPEfsSCSf_cd6glzB_Fwan08",
  authDomain: "test-f82c9.firebaseapp.com",
  databaseURL: "https://test-f82c9-default-rtdb.firebaseio.com",
  projectId: "test-f82c9",
  storageBucket: "test-f82c9.firebasestorage.app",
  messagingSenderId: "1064652444751",
  appId: "1:1064652444751:web:0788f6687896aedf82063a",
  measurementId: "G-3YD17GFX2C"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Firestore ì»¬ë ‰ì…˜ ì°¸ì¡°
const COL = 'sauna_v1'; // ë‹¨ì¼ ë¬¸ì„œë¡œ ëª¨ë“  ë°ì´í„° ê´€ë¦¬
const DOC_ITEMS    = db.collection(COL).doc('items');
const DOC_EQUIPS   = db.collection(COL).doc('equips');
const DOC_LOGS     = db.collection(COL).doc('consLogs');
const DOC_VISITORS = db.collection(COL).doc('visitors');
const DOC_PERHEAD  = db.collection(COL).doc('perHead');
const DOC_CTR      = db.collection(COL).doc('counter');

let isSaving = false;
let saveQueue = false;

// ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ â€” ë‹¤ë¥¸ ì‚¬ìš©ì ë³€ê²½ì‚¬í•­ ì¦‰ì‹œ ë°˜ì˜
function startRealtimeSync(){
  DOC_ITEMS.onSnapshot(snap=>{
    if(!snap.exists) return;
    const d = snap.data();
    items = d.data || JSON.parse(JSON.stringify(DEF_ITEMS));
    items = items.map(i=>({type:'equip',monthlyUsage:0,unit:'ê°œ',stock:0,
      fb1:0,fb2:0,mb1:0,mb2:0,sup:0,emp:0,spare:0,repair:0,discard:0,...i}));
    syncEquipToItems();
    refreshCurrentPage();
  });
  DOC_EQUIPS.onSnapshot(snap=>{
    if(!snap.exists) return;
    const d = snap.data();
    equips = (d.data||[]).map(e=>({
      id:e.id, itemName:e.itemName||'', num:e.num||'',
      generation:e.generation||1,
      model:e.model||'', maker:'', buyMonth:e.buyMonth||'',
      installDate:e.installDate||'', location:e.location||'ì—¬ë¶„',
      status:e.status||'ì‚¬ìš©ì¤‘', discardMonth:e.discardMonth||'',
      discardReason:e.discardReason||'', note:e.note||''
    }));
    syncEquipToItems();
    refreshCurrentPage();
  });
  DOC_LOGS.onSnapshot(snap=>{
    if(!snap.exists) return;
    consLogs = snap.data().data || [];
    refreshCurrentPage();
  });
  DOC_VISITORS.onSnapshot(snap=>{
    if(!snap.exists) return;
    visitors = snap.data().data || {};
    refreshCurrentPage();
  });
  DOC_PERHEAD.onSnapshot(snap=>{
    if(!snap.exists) return;
    perHead = snap.data().data || {};
    refreshCurrentPage();
  });
  DOC_CTR.onSnapshot(snap=>{
    if(!snap.exists) return;
    const d = snap.data();
    nextItemId = d.nextItemId || 20;
    nextEqNum  = d.nextEqNum  || 10;
  });
}

function refreshCurrentPage(){
  const pages = ['dashboard','items','equipment','consumable','manage','analytics'];
  for(const p of pages){
    const el = document.getElementById('page-'+p);
    if(el && el.classList.contains('active')){
      ({dashboard:renderDashboard,items:renderItems,equipment:renderEquip,
        consumable:renderCons,manage:renderManage,analytics:renderAnalytics})[p]?.();
      break;
    }
  }
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEFAULT DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEF_ITEMS = [
  // type:'equip' â€” ì¥ë¹„
  {id:1,type:'equip',name:'ë“œë¼ì´ê¸°',category:'ì „ê¸°ìš©í’ˆ',minStock:60,monthlyUsage:0,unit:'ëŒ€',note:'ë‚¨ì‚¬ ë¶„ì‹¤ 1ê°œ',
   fb1:0,fb2:0,mb1:0,mb2:0,sup:0,emp:0,spare:0,repair:0,discard:0},
  {id:2,type:'equip',name:'íƒˆìˆ˜ê¸°',category:'ì „ê¸°ìš©í’ˆ',minStock:40,monthlyUsage:0,unit:'ëŒ€',note:'ì‚¼ëŒ€ì› 1ëŒ€ / ì›Œí„° 3ëŒ€',
   fb1:0,fb2:0,mb1:0,mb2:0,sup:0,emp:0,spare:0,repair:0,discard:0},
  {id:3,type:'equip',name:'ì„ í’ê¸°(ê¸ˆìƒ‰)',category:'ì „ê¸°ìš©í’ˆ',minStock:15,monthlyUsage:0,unit:'ëŒ€',note:'ì›Œí„° 2ëŒ€',
   fb1:0,fb2:0,mb1:0,mb2:0,sup:0,emp:0,spare:0,repair:0,discard:0},
  {id:4,type:'equip',name:'ì„ í’ê¸°(ê²€ì •)',category:'ì „ê¸°ìš©í’ˆ',minStock:20,monthlyUsage:0,unit:'ëŒ€',note:'',
   fb1:0,fb2:0,mb1:0,mb2:0,sup:0,emp:0,spare:0,repair:0,discard:0},
  {id:5,type:'equip',name:'ë¦°ë„¨í•¨',category:'ìˆ˜ë‚©ìš©í’ˆ',minStock:30,monthlyUsage:0,unit:'ê°œ',note:'ìˆ˜ê¸°ì‘ì„±',
   fb1:0,fb2:0,mb1:0,mb2:0,sup:0,emp:0,spare:0,repair:0,discard:0},
  {id:6,type:'equip',name:'ë“œë¼ì´ê¸° ê±°ì¹˜ëŒ€',category:'ìˆ˜ë‚©ìš©í’ˆ',minStock:10,monthlyUsage:0,unit:'ê°œ',note:'ìˆ˜ê¸°ì‘ì„±',
   fb1:0,fb2:0,mb1:0,mb2:0,sup:0,emp:0,spare:0,repair:0,discard:0},
  // type:'consumable' â€” ì†Œëª¨í’ˆ
  {id:7,type:'consumable',name:'ëŒ€ìš©ëŸ‰ ë°”ë””ì›Œì‹œ',category:'ì†Œëª¨í’ˆ',minStock:20,monthlyUsage:10,unit:'í†µ',note:'',stock:25},
  {id:8,type:'consumable',name:'ëŒ€ìš©ëŸ‰ ìƒ´í‘¸',category:'ì†Œëª¨í’ˆ',minStock:20,monthlyUsage:8,unit:'í†µ',note:'',stock:18},
  {id:9,type:'consumable',name:'ë©´ë´‰',category:'ì†Œëª¨í’ˆ',minStock:50,monthlyUsage:30,unit:'ê°œ',note:'',stock:60},
  {id:10,type:'consumable',name:'ê±´ì „ì§€(AA)',category:'ì†Œëª¨í’ˆ',minStock:30,monthlyUsage:15,unit:'ê°œ',note:'',stock:20},
];

const DEF_EQUIPS = [
  {id:'e1',itemName:'ë“œë¼ì´ê¸°',num:'001',generation:1,model:'íŒŒë‚˜ì†Œë‹‰ EH-NA45',buyMonth:'2024-01',installDate:'2024-01-15',location:'ì—¬ì‚¬ B1',status:'ì‚¬ìš©ì¤‘',discardMonth:'',discardReason:'',note:''},
  {id:'e2',itemName:'ë“œë¼ì´ê¸°',num:'002',generation:1,model:'íŒŒë‚˜ì†Œë‹‰ EH-NA45',buyMonth:'2024-01',installDate:'2024-01-15',location:'ì—¬ì‚¬ B2',status:'ì‚¬ìš©ì¤‘',discardMonth:'',discardReason:'',note:''},
  {id:'e3',itemName:'íƒˆìˆ˜ê¸°',num:'001',generation:1,model:'LG T7WC3HP',buyMonth:'2023-12',installDate:'2023-12-20',location:'ë‚¨ì‚¬ B1',status:'ìˆ˜ë¦¬ì¤‘',discardMonth:'',discardReason:'',note:'ëª¨í„° ë¶ˆëŸ‰'},
  {id:'e4',itemName:'ë“œë¼ì´ê¸°',num:'003',generation:1,model:'íŒŒë‚˜ì†Œë‹‰ EH-NA45',buyMonth:'2026-01',installDate:'2026-01-05',location:'ì—¬ë¶„',status:'íê¸°',discardMonth:'2026-01',discardReason:'ê³¼ì—´ ê³ ì¥',note:''},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUNTIME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let items=[], equips=[], consLogs=[];
let visitors={};   // { '2026-01': 12500, '2026-02': 9800, ... }
let perHead={};    // { itemId: 0.05, ... }  â€” 1ì¸ë‹¹ ì†Œëª¨ëŸ‰ (ìˆ˜ë™ ì„¤ì •)
let nextItemId=20, nextEqNum=10;
let itemSearchQ='', equipSearch='', consSearch='';
let activeCat='';
let currentInOutType='in';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ì•± ì‹œì‘ ì‹œ 1íšŒ) â”€â”€
async function loadData(){
  try{
    showLoadingOverlay(true);
    const [si,se,sc,sv,sp,sct] = await Promise.all([
      DOC_ITEMS.get(), DOC_EQUIPS.get(), DOC_LOGS.get(),
      DOC_VISITORS.get(), DOC_PERHEAD.get(), DOC_CTR.get()
    ]);
    items    = si.exists  ? (si.data().data  || JSON.parse(JSON.stringify(DEF_ITEMS)))  : JSON.parse(JSON.stringify(DEF_ITEMS));
    equips   = se.exists  ? (se.data().data  || JSON.parse(JSON.stringify(DEF_EQUIPS))) : JSON.parse(JSON.stringify(DEF_EQUIPS));
    consLogs = sc.exists  ? (sc.data().data  || []) : [];
    visitors = sv.exists  ? (sv.data().data  || {}) : {};
    perHead  = sp.exists  ? (sp.data().data  || {}) : {};
    if(sct.exists){const d=sct.data();nextItemId=d.nextItemId||20;nextEqNum=d.nextEqNum||10;}

    // ì²« ì‹¤í–‰: ê¸°ë³¸ ë°ì´í„° ì €ì¥
    if(!si.exists) await DOC_ITEMS.set({data: items});
    if(!se.exists) await DOC_EQUIPS.set({data: equips});

    equips=equips.map(e=>({
      id:e.id, itemName:e.itemName||'', num:e.num||e.serial||'',
      generation:e.generation||1,
      model:e.model||'', maker:'', buyMonth:e.buyMonth||'',
      installDate:e.installDate||'', location:e.location||'ì—¬ë¶„',
      status:e.status||'ì‚¬ìš©ì¤‘', discardMonth:e.discardMonth||'',
      discardReason:e.discardReason||'', note:e.note||''
    }));
    items=items.map(i=>({type:'equip',monthlyUsage:0,unit:'ê°œ',stock:0,
      fb1:0,fb2:0,mb1:0,mb2:0,sup:0,emp:0,spare:0,repair:0,discard:0,...i}));
    syncEquipToItems();
  }catch(e){
    console.warn('ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©',e);
    items=JSON.parse(JSON.stringify(DEF_ITEMS));
    equips=JSON.parse(JSON.stringify(DEF_EQUIPS));
    consLogs=[];visitors={};perHead={};
    syncEquipToItems();
  } finally {
    showLoadingOverlay(false);
  }
}

// â”€â”€ ì €ì¥ (ë””ë°”ìš´ìŠ¤ ì ìš© â€” ì—°ì† í˜¸ì¶œ ì‹œ ë§ˆì§€ë§‰ 1ë²ˆë§Œ) â”€â”€
let saveTimer = null;
function saveData(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>_doSave(), 400);
}
async function _doSave(){
  try{
    const batch = db.batch();
    batch.set(DOC_ITEMS,    {data: items,    updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
    batch.set(DOC_EQUIPS,   {data: equips,   updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
    batch.set(DOC_LOGS,     {data: consLogs, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
    batch.set(DOC_VISITORS, {data: visitors, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
    batch.set(DOC_PERHEAD,  {data: perHead,  updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
    batch.set(DOC_CTR,      {nextItemId, nextEqNum});
    await batch.commit();
  }catch(e){
    console.warn('ì €ì¥ ì‹¤íŒ¨',e);
    toast('ì €ì¥ ì‹¤íŒ¨ â€” ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”','âŒ');
  }
}

function resetAllData(){
  if(!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?\në“±ë¡í•˜ì‹  í’ˆëª©Â·ì¥ë¹„Â·ì´ë ¥Â·ë¶„ì„ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) return;
  items=JSON.parse(JSON.stringify(DEF_ITEMS));
  equips=JSON.parse(JSON.stringify(DEF_EQUIPS));
  consLogs=[];visitors={};perHead={};nextItemId=20;nextEqNum=10;
  syncEquipToItems(); saveData(); activeCat='';
  renderDashboard();renderItems();renderManage();renderEquip();renderCons();
  if(document.getElementById('page-analytics').classList.contains('active')) renderAnalytics();
  toast('ì´ˆê¸°í™” ì™„ë£Œ','ğŸ”„');
}

// â”€â”€ ë¡œë”© ì˜¤ë²„ë ˆì´ â”€â”€
function showLoadingOverlay(show){
  let el = document.getElementById('loading-overlay');
  if(!el){
    el = document.createElement('div');
    el.id = 'loading-overlay';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(15,17,23,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px;';
    el.innerHTML = `<div style="width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite"></div>
      <div style="color:var(--text2);font-size:14px">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;
    document.body.appendChild(el);
  }
  el.style.display = show ? 'flex' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const getEquipTotal  = i => i.fb1+i.fb2+i.mb1+i.mb2+i.sup+i.emp+i.spare+i.repair+i.discard;
const getEquipActive = i => i.fb1+i.fb2+i.mb1+i.mb2+i.sup+i.emp+i.spare;
// ì†Œëª¨í’ˆ í˜„ì¬ì¬ê³  = stock í•„ë“œ
const getStock = i => i.type==='consumable' ? (i.stock||0) : getEquipActive(i);
// ìµì›” êµ¬ë§¤ ê¶Œì¥ëŸ‰: ë¶€ì¡±ë¶„ + ì›”ì†Œëª¨ëŸ‰ (ì—¬ìœ ë¶„ í¬í•¨)
function getNextBuy(i){
  const s=getStock(i);
  const shortage=Math.max(0,i.minStock-s);
  const monthly=i.monthlyUsage||0;
  // ë‘˜ ë‹¤ í‘œì‹œ: shortage + monthly
  return {shortage, monthly, total: shortage+monthly};
}
function getStatus(i){
  const s=getStock(i), min=i.minStock||0;
  if(s<=0||s<min*0.5) return 'danger';
  if(s<min) return 'warn';
  return 'ok';
}
function nowMonth(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;}
function nowDate(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;}
function fmtDate(d){return d||'-';}
function escQ(s){return(s||'').replace(/'/g,"&#39;").replace(/"/g,'&quot;');}

// Sync equip counts â†’ item stock fields
function syncEquipToItems(){
  const locKey={'ì—¬ì‚¬ B1':'fb1','ì—¬ì‚¬ B2':'fb2','ë‚¨ì‚¬ B1':'mb1','ë‚¨ì‚¬ B2':'mb2','ì§€ì›íŒ€':'sup','ì§ì›ìš©':'emp','ì—¬ë¶„':'spare'};
  const stKey={'ìˆ˜ë¦¬ì¤‘':'repair','íê¸°':'discard'};
  items.filter(i=>i.type==='equip').forEach(item=>{
    item.fb1=0;item.fb2=0;item.mb1=0;item.mb2=0;item.sup=0;item.emp=0;item.spare=0;item.repair=0;item.discard=0;
    equips.filter(e=>e.itemName===item.name).forEach(e=>{
      if(stKey[e.status]) item[stKey[e.status]]++;
      else{ const k=locKey[e.location]; if(k) item[k]++; }
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTab(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('page-'+tab).classList.add('active');
  ({dashboard:renderDashboard,items:renderItems,equipment:renderEquip,consumable:renderCons,manage:renderManage,analytics:renderAnalytics})[tab]?.();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const equipItems=items.filter(i=>i.type==='equip');
  const consItems=items.filter(i=>i.type==='consumable');
  const allLow=items.filter(i=>getStatus(i)!=='ok');
  document.getElementById('alert-area').innerHTML=allLow.length
    ?`<div class="alert-bar">âš ï¸ <strong>${allLow.length}ê°œ í’ˆëª©</strong> ì¬ê³  ê¸°ì¤€ ë¯¸ë‹¬: ${allLow.map(i=>i.name).join(', ')}</div>`:'' ;

  // Top stats
  const totalEquip=equipItems.reduce((s,i)=>s+getEquipTotal(i),0);
  const repairQty=equipItems.reduce((s,i)=>s+i.repair,0);
  const discQty=equipItems.reduce((s,i)=>s+i.discard,0);
  const needEquip=equipItems.reduce((s,i)=>s+getNextBuy(i).shortage,0);
  const needCons=consItems.reduce((s,i)=>s+getNextBuy(i).total,0);
  const thisMonBuy=equips.filter(e=>e.buyMonth===nowMonth()).length;
  document.getElementById('stat-cards').innerHTML=`
    <div class="stat-card" style="--cc:var(--accent)"><div class="stat-lbl">ì „ì²´ í’ˆëª©</div><div class="stat-val">${items.length}</div><div class="stat-sub">ì¥ë¹„ ${equipItems.length} Â· ì†Œëª¨í’ˆ ${consItems.length}</div></div>
    <div class="stat-card" style="--cc:var(--green)"><div class="stat-lbl">ì¥ë¹„ ì´ ìˆ˜ëŸ‰</div><div class="stat-val">${totalEquip}</div><div class="stat-sub">ìˆ˜ë¦¬ ${repairQty} Â· íê¸° ${discQty}</div></div>
    <div class="stat-card" style="--cc:var(--orange)"><div class="stat-lbl">ì†Œëª¨í’ˆ ì´ ì¬ê³ </div><div class="stat-val">${consItems.reduce((s,i)=>s+(i.stock||0),0)}</div><div class="stat-sub">${consItems.length}ì¢… ê´€ë¦¬ ì¤‘</div></div>
    <div class="stat-card" style="--cc:var(--red)"><div class="stat-lbl">ì¥ë¹„ êµ¬ë§¤ í•„ìš”</div><div class="stat-val" style="color:${needEquip>0?'var(--red)':'var(--green)'}">${needEquip}</div><div class="stat-sub">ë¶€ì¡±ë¶„ í•©ê³„</div></div>
    <div class="stat-card" style="--cc:var(--purple)"><div class="stat-lbl">ì†Œëª¨í’ˆ ìµì›” êµ¬ë§¤</div><div class="stat-val" style="color:${needCons>0?'var(--orange)':'var(--green)'}">${needCons}</div><div class="stat-sub">ë¶€ì¡±+ì›”ì†Œëª¨ í•©ê³„</div></div>
    <div class="stat-card" style="--cc:var(--teal)"><div class="stat-lbl">ë‹¹ì›” êµ¬ë§¤ ì¥ë¹„</div><div class="stat-val">${thisMonBuy}</div><div class="stat-sub">${nowMonth()} ë“±ë¡</div></div>
  `;

  // Equip buy cards
  document.getElementById('equip-buy-cards').innerHTML=equipItems.map(item=>{
    const active=getEquipActive(item),nb=getNextBuy(item);
    const pct=item.minStock>0?Math.min(100,Math.round(active/item.minStock*100)):100;
    const cls=nb.shortage>0&&pct<50?'urgent':nb.shortage>0?'caution':'ok';
    const bc=cls==='urgent'?'var(--red)':cls==='caution'?'var(--yellow)':'var(--green)';
    return `<div class="buy-card ${cls}">
      <div><span class="buy-type-tag tag-equip">ğŸ”§ ì¥ë¹„</span></div>
      <div class="buy-cname">${item.name}</div>
      <div class="buy-bar"><div class="buy-bar-fill" style="width:${pct}%;background:${bc}"></div></div>
      <div class="buy-row"><span>ì‹¤ì‚¬ìš© ê°€ëŠ¥</span><span>${active}</span></div>
      <div class="buy-row"><span>ê¸°ì¤€ ì¬ê³ </span><span>${item.minStock}</span></div>
      <div style="border-top:1px solid var(--border);padding-top:7px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:11px;color:var(--text3)">êµ¬ë§¤ í•„ìš”</span>
        <span class="buy-need" style="color:${bc}">${nb.shortage>0?'+'+nb.shortage:'âœ“ ì¶©ì¡±'}</span>
      </div>
    </div>`;
  }).join('');

  // Consumable buy cards
  document.getElementById('cons-buy-cards').innerHTML=consItems.map(item=>{
    const s=item.stock||0,nb=getNextBuy(item);
    const pct=item.minStock>0?Math.min(100,Math.round(s/item.minStock*100)):100;
    const cls=nb.shortage>0&&pct<50?'urgent':nb.shortage>0?'caution':'ok';
    const bc=cls==='urgent'?'var(--red)':cls==='caution'?'var(--yellow)':'var(--green)';
    return `<div class="buy-card ${cls}">
      <div><span class="buy-type-tag tag-consumable">ğŸ§´ ì†Œëª¨í’ˆ</span></div>
      <div class="buy-cname">${item.name}</div>
      <div class="buy-bar"><div class="buy-bar-fill" style="width:${pct}%;background:${bc}"></div></div>
      <div class="buy-row"><span>í˜„ì¬ ì¬ê³ </span><span>${s} ${item.unit||'ê°œ'}</span></div>
      <div class="buy-row"><span>ê¸°ì¤€ ì¬ê³ </span><span>${item.minStock}</span></div>
      <div class="buy-row"><span>ì›” ì†Œëª¨ëŸ‰</span><span>${item.monthlyUsage||0}</span></div>
      <div style="border-top:1px solid var(--border);padding-top:7px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
          <span style="font-size:11px;color:var(--text3)">ë¶€ì¡±ë¶„</span>
          <span style="font-size:13px;font-weight:700;color:${nb.shortage>0?'var(--red)':'var(--green)'}">${nb.shortage>0?'+'+nb.shortage:'ì¶©ì¡±'}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:11px;color:var(--text3)">ìµì›” ê¶Œì¥ êµ¬ë§¤</span>
          <span class="buy-need" style="color:${bc}">${nb.total>0?'+'+nb.total:'âœ“'}</span>
        </div>
      </div>
    </div>`;
  }).join('');

  // Summary table
  document.getElementById('dash-tbody').innerHTML=items.map(item=>{
    const s=getStock(item),nb=getNextBuy(item),st=getStatus(item);
    const pct=item.minStock>0?Math.min(100,Math.round(s/item.minStock*100)):100;
    const fc=st==='ok'?'#22c55e':st==='warn'?'#f59e0b':'#ef4444';
    const stB=st==='ok'?'<span class="badge b-ok">âœ“ ì •ìƒ</span>':st==='warn'?'<span class="badge b-warn">âš  ë¶€ì¡±</span>':'<span class="badge b-danger">âœ• ìœ„í—˜</span>';
    const typeB=item.type==='equip'?'<span class="badge b-info">ğŸ”§ ì¥ë¹„</span>':'<span class="badge b-orange">ğŸ§´ ì†Œëª¨í’ˆ</span>';
    const monthly=item.monthlyUsage?item.monthlyUsage+' '+item.unit:'-';
    const nextBuyTxt=nb.total>0?`<span class="badge b-danger">+${nb.total}</span>`:'<span class="badge b-ok">ì¶©ì¡±</span>';
    return `<tr class="${item.type==='equip'?'tr-equip':'tr-consumable'}">
      <td>${typeB}</td>
      <td><strong>${item.name}</strong>${item.note?`<br><span style="font-size:11px;color:var(--text3)">${item.note}</span>`:''}</td>
      <td><strong class="mono">${s}</strong> ${item.unit||''}</td>
      <td>${item.minStock} ${item.unit||''}</td>
      <td>${monthly}</td>
      <td>${nextBuyTxt}</td>
      <td><div class="pbar"><div class="pbar-fill" style="width:${pct}%;background:${fc}"></div></div>${stB}</td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ITEMS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderItems(){
  const tf=document.getElementById('item-type-filter')?.value||'';
  const f=items.filter(i=>{
    const mq=i.name.includes(itemSearchQ)||i.category.includes(itemSearchQ);
    const mt=!tf||i.type===tf;
    return mq&&mt;
  });
  document.getElementById('items-tbody').innerHTML=f.map(item=>{
    const s=getStock(item),nb=getNextBuy(item),st=getStatus(item);
    const badge=st==='ok'?'<span class="badge b-ok">ì •ìƒ</span>':st==='warn'?'<span class="badge b-warn">ë¶€ì¡±</span>':'<span class="badge b-danger">ìœ„í—˜</span>';
    const typeB=item.type==='equip'?'<span class="badge b-info">ì¥ë¹„</span>':'<span class="badge b-orange">ì†Œëª¨í’ˆ</span>';
    const actionBtn=item.type==='equip'
      ?`<button class="btn btn-ghost btn-sm" onclick="openQty(${item.id})">ìˆ˜ëŸ‰ì¡°ì •</button>`
      :`<button class="btn btn-orange btn-sm" onclick="openInOutFor(${item.id},'in')">ì…ê³ </button><button class="btn btn-danger btn-sm" onclick="openInOutFor(${item.id},'out')">ì¶œê³ </button>`;

    // ì¥ë¹„: ìœ„ì¹˜ë³„ ìˆ˜ëŸ‰ breakdown
    const stockCell = item.type==='equip' ? `
      <strong class="mono" style="font-size:15px">${s}</strong> ${item.unit||''}
      <div style="font-size:10px;color:var(--text3);margin-top:3px;line-height:1.6">
        ${item.fb1>0?`ì—¬ì‚¬B1 ${item.fb1} `:''}${item.fb2>0?`ì—¬ì‚¬B2 ${item.fb2} `:''}${item.mb1>0?`ë‚¨ì‚¬B1 ${item.mb1} `:''}${item.mb2>0?`ë‚¨ì‚¬B2 ${item.mb2} `:''}${item.sup>0?`ì§€ì›íŒ€ ${item.sup} `:''}${item.emp>0?`ì§ì›ìš© ${item.emp} `:''}${item.spare>0?`ì—¬ë¶„ ${item.spare} `:''}
        ${item.repair>0?`<span style="color:var(--yellow)">ìˆ˜ë¦¬ì¤‘ ${item.repair}</span> `:''}${item.discard>0?`<span style="color:var(--red)">íê¸° ${item.discard}</span>`:''}
      </div>` : `<strong class="mono" style="font-size:15px">${s}</strong> ${item.unit||''}`;

    return `<tr class="${item.type==='equip'?'tr-equip':'tr-consumable'}">
      <td>${typeB}</td>
      <td><strong>${item.name}</strong>${item.note?`<br><span style="font-size:11px;color:var(--text3)">${item.note}</span>`:''}</td>
      <td><span class="badge b-info">${item.category}</span></td>
      <td>${stockCell}</td>
      <td>${item.minStock}</td>
      <td>${item.monthlyUsage||'-'}</td>
      <td>${nb.total>0?`<span class="badge b-danger">+${nb.total}</span>`:'<span class="badge b-ok">ì¶©ì¡±</span>'}</td>
      <td>${badge}</td>
      <td style="white-space:nowrap;display:flex;gap:4px;flex-wrap:wrap">
        ${actionBtn}
        <button class="btn btn-ghost btn-sm" onclick="openEditItem(${item.id})">í¸ì§‘</button>
      </td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSUMABLE PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCons(){
  const consItems=items.filter(i=>i.type==='consumable');
  const year=parseInt(document.getElementById('cons-year-sel')?.value||new Date().getFullYear());

  // í’ˆëª© í•„í„° ì…€ë ‰íŠ¸
  const sel=document.getElementById('cf-item');
  if(sel){const cv=sel.value;sel.innerHTML='<option value="">ì „ì²´ í’ˆëª©</option>'+consItems.map(i=>`<option value="${i.id}"${i.id==cv?' selected':''}>${i.name}</option>`).join('');}

  // â”€â”€ ì¬ê³  ì¹´ë“œ â”€â”€
  document.getElementById('cons-summary-cards').innerHTML=consItems.map(item=>{
    const s=item.stock||0,nb=getNextBuy(item),st=getStatus(item);
    const bc=st==='danger'?'var(--red)':st==='warn'?'var(--yellow)':'var(--green)';
    const cls=st==='danger'?'urgent':st==='warn'?'caution':'ok';
    const pct=item.minStock>0?Math.min(100,Math.round(s/item.minStock*100)):100;
    return `<div class="buy-card ${cls}">
      <div class="buy-cname">${item.name}</div>
      <div class="buy-bar"><div class="buy-bar-fill" style="width:${pct}%;background:${bc}"></div></div>
      <div class="buy-row"><span>í˜„ì¬ ì¬ê³ </span><span>${s} ${item.unit||'ê°œ'}</span></div>
      <div class="buy-row"><span>ê¸°ì¤€ ì¬ê³ </span><span>${item.minStock}</span></div>
      <div class="buy-row"><span>ì›” ì†Œëª¨ëŸ‰</span><span>${item.monthlyUsage||0}</span></div>
      <div class="buy-row"><span>ìµì›” êµ¬ë§¤ ê¶Œì¥</span><span style="color:${bc};font-weight:700">${nb.total>0?'+'+nb.total+' '+item.unit:'ì¶©ì¡±'}</span></div>
      <div style="display:flex;gap:4px;margin-top:6px">
        <button class="btn btn-orange btn-sm" style="flex:1" onclick="openInOutFor(${item.id},'in')">ğŸ›’ êµ¬ë§¤</button>
        <button class="btn btn-danger btn-sm" style="flex:1" onclick="openInOutFor(${item.id},'out')">ğŸ“¦ ì†Œëª¨</button>
      </div>
    </div>`;
  }).join('');

  // â”€â”€ ì›”ë³„ ëˆ„ê³„ í…Œì´ë¸” â”€â”€
  const months=['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
  const mk=(m)=>`${year}-${String(m).padStart(2,'0')}`;
  document.getElementById('cons-monthly-head').innerHTML=
    `<th style="padding:10px 14px;font-size:11px;font-weight:700;color:var(--text3);background:var(--surface2);min-width:120px">í’ˆëª©</th>`+
    months.map(m=>`<th style="padding:10px 12px;font-size:11px;font-weight:700;color:var(--text3);background:var(--surface2);text-align:center;min-width:80px">${m}</th>`).join('');

  document.getElementById('cons-monthly-body').innerHTML=consItems.map(item=>{
    const cells=months.map((_,i)=>{
      const mkey=mk(i+1);
      const buyQty=consLogs.filter(l=>l.itemId===item.id&&l.type==='in'&&(l.date||'').startsWith(mkey)).reduce((s,l)=>s+l.qty,0);
      const useQty=consLogs.filter(l=>l.itemId===item.id&&l.type==='out'&&(l.date||'').startsWith(mkey)).reduce((s,l)=>s+l.qty,0);
      const isCur=mkey===nowMonth().substring(0,7);
      const isFut=mkey>nowMonth().substring(0,7);
      let cell='';
      if(buyQty>0) cell+=`<div style="color:var(--green);font-weight:700;font-family:'IBM Plex Mono',monospace;font-size:12px">+${buyQty} <span style="font-size:10px;font-weight:400">êµ¬ë§¤</span></div>`;
      if(useQty>0) cell+=`<div style="color:var(--orange);font-weight:700;font-family:'IBM Plex Mono',monospace;font-size:12px">-${useQty} <span style="font-size:10px;font-weight:400">ì†Œëª¨</span></div>`;
      if(!buyQty&&!useQty) cell=`<span style="color:var(--text3);font-size:12px">-</span>`;
      const bg=isCur?'rgba(79,142,247,.06)':isFut?'rgba(255,255,255,.01)':'';
      return `<td style="padding:10px 12px;text-align:center;background:${bg};${isCur?'border-top:1px solid rgba(79,142,247,.3);border-bottom:1px solid rgba(79,142,247,.3)':''}">${cell}</td>`;
    }).join('');
    return `<tr style="border-bottom:1px solid var(--border)">
      <td style="padding:10px 14px;font-weight:600;font-size:13px">${item.name}<br><span style="font-size:11px;color:var(--text3);font-weight:400">${item.unit||'ê°œ'}</span></td>
      ${cells}
    </tr>`;
  }).join('');

  // â”€â”€ ìƒì„¸ ì´ë ¥ (ê±´ë³„, ì‹¬í”Œ) â”€â”€
  const filterItemId=document.getElementById('cf-item')?.value||'';
  const filtered=[...consLogs].reverse().filter(l=>{
    const mi=!filterItemId||l.itemId==filterItemId;
    const mq=!consSearch||l.itemName.includes(consSearch)||(l.note||'').includes(consSearch);
    return mi&&mq;
  });
  const logEl=document.getElementById('cons-log-list');
  if(!filtered.length){logEl.innerHTML='<div class="empty-st">ë“±ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';return;}

  // ë‚ ì§œë³„ ê·¸ë£¹
  const byDate={};
  filtered.forEach(l=>{const d=l.date||'ë‚ ì§œì—†ìŒ';if(!byDate[d])byDate[d]=[];byDate[d].push(l);});

  logEl.innerHTML=Object.entries(byDate).map(([date,logs])=>`
    <div style="padding:10px 18px 2px;background:var(--surface2);border-bottom:1px solid var(--border);">
      <span style="font-size:11px;font-weight:700;color:var(--text3);font-family:'IBM Plex Mono',monospace">${date}</span>
    </div>
    ${logs.map(l=>{
      const isIn=l.type==='in';
      const col=isIn?'var(--green)':'var(--orange)';
      const label=isIn?'êµ¬ë§¤':'ì†Œëª¨';
      const icon=isIn?'ğŸ›’':'ğŸ“¦';
      return `<div style="display:flex;align-items:center;padding:10px 18px;border-bottom:1px solid var(--border);gap:10px;transition:background .1s;" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">
        <span style="font-size:16px">${icon}</span>
        <div style="flex:1;min-width:0;">
          <span style="font-weight:600;font-size:13px">${l.itemName}</span>
          <span style="color:${col};font-weight:700;margin-left:8px;font-family:'IBM Plex Mono',monospace">${isIn?'+':'-'}${l.qty} ${l.unit||'ê°œ'}</span>
          <span class="badge ${isIn?'b-ok':'b-orange'}" style="margin-left:6px;font-size:10px">${label}</span>
          ${l.note?`<span style="font-size:11px;color:var(--text3);margin-left:8px">${l.note}</span>`:''}
        </div>
        <div style="text-align:right;flex-shrink:0;">
          <div style="font-size:11px;color:var(--text3)">ì¬ê³ : ${l.stockAfter} ${l.unit||'ê°œ'}</div>
          <button class="btn btn-ghost btn-sm" style="margin-top:3px;padding:2px 8px;font-size:11px;" onclick="openLogEdit('${l.id}')">ìˆ˜ì •</button>
        </div>
      </div>`;
    }).join('')}
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INOUT MODAL (ì†Œëª¨í’ˆ êµ¬ë§¤/ì†Œëª¨)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let inoutTargetItemId=null;
function openInOut(type){
  inoutTargetItemId=null;
  const consItems=items.filter(i=>i.type==='consumable');
  document.getElementById('io-item').innerHTML=consItems.map(i=>`<option value="${i.id}">${i.name} (í˜„ì¬: ${i.stock||0} ${i.unit||'ê°œ'})</option>`).join('');
  document.getElementById('io-qty').value=1;
  document.getElementById('io-date').value=nowDate();
  document.getElementById('io-note').value='';
  switchInOut(type);
  openM('inout-modal');
}
function openInOutFor(itemId,type){
  inoutTargetItemId=itemId;
  const consItems=items.filter(i=>i.type==='consumable');
  const sel=document.getElementById('io-item');
  sel.innerHTML=consItems.map(i=>`<option value="${i.id}"${i.id===itemId?' selected':''}>${i.name} (í˜„ì¬: ${i.stock||0} ${i.unit||'ê°œ'})</option>`).join('');
  document.getElementById('io-qty').value=1;
  document.getElementById('io-date').value=nowDate();
  document.getElementById('io-note').value='';
  switchInOut(type);
  openM('inout-modal');
}
function switchInOut(type){
  currentInOutType=type;
  const tin=document.getElementById('inout-tab-in');
  const tout=document.getElementById('inout-tab-out');
  const sbtn=document.getElementById('inout-save-btn');
  const title=document.getElementById('inout-modal-title');
  tin.className='inout-tab'+(type==='in'?' active-in':'');
  tout.className='inout-tab'+(type==='out'?' active-out':'');
  sbtn.textContent=type==='in'?'êµ¬ë§¤ ì €ì¥':'ì†Œëª¨ ì €ì¥';
  sbtn.className='btn '+(type==='in'?'btn-primary':'btn-danger');
  title.textContent=type==='in'?'ğŸ›’ êµ¬ë§¤ ë“±ë¡':'ğŸ“¦ ì†Œëª¨ ë“±ë¡';
}
function saveInOut(){
  const itemId=parseInt(document.getElementById('io-item').value);
  const item=items.find(i=>i.id===itemId);
  if(!item){toast('í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”','âš ï¸');return;}
  const qty=parseInt(document.getElementById('io-qty').value)||0;
  if(qty<=0){toast('ìˆ˜ëŸ‰ì„ 1 ì´ìƒ ì…ë ¥í•˜ì„¸ìš”','âš ï¸');return;}
  const before=item.stock||0;
  if(currentInOutType==='in') item.stock=before+qty;
  else item.stock=Math.max(0,before-qty);
  consLogs.push({
    id:'cl'+Date.now(),
    itemId,itemName:item.name,unit:item.unit||'ê°œ',
    type:currentInOutType,qty,
    stockBefore:before,stockAfter:item.stock,
    date:document.getElementById('io-date').value,
    note:document.getElementById('io-note').value
  });
  saveData();
  closeM('inout-modal');
  renderCons();renderDashboard();
  if(document.getElementById('page-items').classList.contains('active')) renderItems();
  toast(`${item.name} ${currentInOutType==='in'?'êµ¬ë§¤':'ì†Œëª¨'} ${qty}${item.unit||'ê°œ'}`, currentInOutType==='in'?'ğŸ›’':'ğŸ“¦');
}

// â”€â”€ ì´ë ¥ ìˆ˜ì •/ì‚­ì œ â”€â”€
function openLogEdit(logId){
  const log=consLogs.find(l=>l.id===logId);
  if(!log)return;
  document.getElementById('le-id').value=logId;
  document.getElementById('le-qty').value=log.qty;
  document.getElementById('le-date').value=log.date||'';
  document.getElementById('le-note').value=log.note||'';
  setLogEditType(log.type);
  openM('log-edit-modal');
}
function setLogEditType(type){
  document.getElementById('le-type').value=type;
  document.getElementById('le-type-in').className='btn btn-sm '+(type==='in'?'btn-orange':'btn-ghost');
  document.getElementById('le-type-out').className='btn btn-sm '+(type==='out'?'btn-danger':'btn-ghost');
}
function saveLogEdit(){
  const logId=document.getElementById('le-id').value;
  const log=consLogs.find(l=>l.id===logId);
  if(!log)return;
  const item=items.find(i=>i.id===log.itemId);
  if(!item)return;
  const oldQty=log.qty, oldType=log.type;
  const newQty=parseInt(document.getElementById('le-qty').value)||0;
  const newType=document.getElementById('le-type').value;
  if(newQty<=0){toast('ìˆ˜ëŸ‰ì„ 1 ì´ìƒ ì…ë ¥í•˜ì„¸ìš”','âš ï¸');return;}
  // ì¬ê³  ì—­ì‚°: ì´ì „ íš¨ê³¼ ë˜ëŒë¦¬ê¸°
  if(oldType==='in') item.stock=Math.max(0,item.stock-oldQty);
  else item.stock=item.stock+oldQty;
  // ìƒˆ íš¨ê³¼ ì ìš©
  if(newType==='in') item.stock=item.stock+newQty;
  else item.stock=Math.max(0,item.stock-newQty);
  // ë¡œê·¸ ì—…ë°ì´íŠ¸
  log.qty=newQty;
  log.type=newType;
  log.date=document.getElementById('le-date').value;
  log.note=document.getElementById('le-note').value;
  log.stockAfter=item.stock;
  saveData();
  closeM('log-edit-modal');
  renderCons();renderDashboard();
  toast('ì´ë ¥ ìˆ˜ì •ë¨','âœ…');
}
function deleteLog(){
  const logId=document.getElementById('le-id').value;
  const log=consLogs.find(l=>l.id===logId);
  if(!log||!confirm('ì´ ì´ë ¥ì„ ì‚­ì œí• ê¹Œìš”?\nì¬ê³ ë„ í•¨ê»˜ ì—­ì‚°ë©ë‹ˆë‹¤.'))return;
  const item=items.find(i=>i.id===log.itemId);
  if(item){
    if(log.type==='in') item.stock=Math.max(0,(item.stock||0)-log.qty);
    else item.stock=(item.stock||0)+log.qty;
  }
  consLogs=consLogs.filter(l=>l.id!==logId);
  saveData();
  closeM('log-edit-modal');
  renderCons();renderDashboard();
  toast('ì´ë ¥ ì‚­ì œë¨','ğŸ—‘');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EQUIPMENT PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EQUIPMENT PAGE â€” ì„¸ëŒ€ ê´€ë¦¬ (Aì•ˆ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let equipTabMode = 'active'; // 'active' | 'archive'

function setEquipTab(mode){
  equipTabMode = mode;
  const btnActive  = document.getElementById('equip-tab-active');
  const btnArchive = document.getElementById('equip-tab-archive');
  if(btnActive){
    btnActive.style.background  = mode==='active'  ? 'var(--accent)' : 'transparent';
    btnActive.style.color       = mode==='active'  ? '#fff'          : 'var(--text3)';
    btnArchive.style.background = mode==='archive' ? 'var(--red)'    : 'transparent';
    btnArchive.style.color      = mode==='archive' ? '#fff'          : 'var(--text3)';
  }
  const sf = document.getElementById('ef-status');
  if(sf) sf.style.display = mode==='archive' ? 'none' : '';
  renderEquip();
}

function renderEquip(){
  const equipItems = items.filter(i=>i.type==='equip');
  const cats = equipItems.map(i=>i.name);
  if(activeCat && !cats.includes(activeCat)) activeCat='';
  if(!activeCat && cats.length) activeCat = cats[0];

  document.getElementById('cat-pills').innerHTML = cats.map(c=>{
    const cnt = equipTabMode==='active'
      ? equips.filter(e=>e.itemName===c && e.status!=='íê¸°').length
      : equips.filter(e=>e.itemName===c && e.status==='íê¸°').length;
    return `<div class="cat-pill${c===activeCat?' active':''}" onclick="activeCat='${c}';renderEquip()">
      ${c} <span class="cnt">${cnt}</span></div>`;
  }).join('');

  const list = filteredEquips(activeCat);
  const area = document.getElementById('equip-table-area');
  equipTabMode==='archive' ? renderArchiveTable(list,area) : renderActiveTable(list,area);
}

function filteredEquips(cat){
  const sf = document.getElementById('ef-status')?.value||'';
  return equips.filter(e=>{
    const mc = !cat || e.itemName===cat;
    const mq = !equipSearch||(e.num||'').includes(equipSearch)||(e.model||'').toLowerCase().includes(equipSearch.toLowerCase())||(e.note||'').includes(equipSearch);
    if(equipTabMode==='archive') return mc && mq && e.status==='íê¸°';
    const ms = !sf || e.status===sf;
    return mc && ms && mq && e.status!=='íê¸°';
  });
}

function renderActiveTable(list, area){
  if(!list.length){ area.innerHTML='<div class="empty-st">ë“±ë¡ëœ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  area.innerHTML=`
    <div class="thead-row" style="border-radius:0">
      <div class="ttitle">ğŸ”§ ${activeCat||'ì „ì²´'} â€” í˜„ì¬ ì¥ë¹„ (${list.length}ëŒ€)</div>
      <div class="tctrls"><span style="font-size:12px;color:var(--text3)">âœï¸ ì…€ í´ë¦­ â†’ ì¸ë¼ì¸ í¸ì§‘</span></div>
    </div>
    <div style="overflow-x:auto"><table class="equip-detail-table">
      <thead><tr>
        <th style="min-width:70px">ë²ˆí˜¸</th><th style="min-width:50px">ì„¸ëŒ€</th>
        <th style="min-width:150px">ì œì¡°ì‚¬/ëª¨ë¸</th><th style="min-width:90px">êµ¬ë§¤ì›”</th>
        <th style="min-width:100px">ì„¤ì¹˜ì¼</th><th style="min-width:90px">ì„¤ì¹˜ìœ„ì¹˜</th>
        <th style="min-width:80px">ìƒíƒœ</th><th style="min-width:120px">ë©”ëª¨</th>
        <th style="min-width:70px">í¸ì§‘</th><th style="min-width:80px">íê¸°ì²˜ë¦¬</th>
      </tr></thead>
      <tbody>${list.map(eq=>renderActiveRow(eq)).join('')}</tbody>
    </table></div>`;
}

function renderActiveRow(eq){
  const sc={'ì‚¬ìš©ì¤‘':'b-ok','ìˆ˜ë¦¬ì¤‘':'b-warn','ì—¬ë¶„':'b-info'};
  const lo=['ì—¬ì‚¬ B1','ì—¬ì‚¬ B2','ë‚¨ì‚¬ B1','ë‚¨ì‚¬ B2','ì§€ì›íŒ€','ì§ì›ìš©','ì—¬ë¶„'];
  const st=['ì‚¬ìš©ì¤‘','ìˆ˜ë¦¬ì¤‘','ì—¬ë¶„'];
  const dash='<span style="color:var(--text3)">-</span>';
  const gen = eq.generation||1;
  const genBadge = gen>1
    ? `<span style="font-size:10px;background:rgba(139,92,246,.2);color:var(--purple);border-radius:4px;padding:2px 6px;font-weight:700">${gen}ì„¸ëŒ€</span>`
    : `<span style="font-size:10px;color:var(--text3)">1ì„¸ëŒ€</span>`;
  const ageMos = eq.buyMonth ? Math.floor((new Date()-new Date(eq.buyMonth+'-01'))/1000/60/60/24/30) : 0;
  const ageStr = ageMos>=12 ? (ageMos/12).toFixed(1)+'ë…„' : ageMos+'ê°œì›”';
  return `<tr id="erow-${eq.id}">
    <td><span class="editable-cell" onclick="ie('${eq.id}','num','${escQ(eq.num||'')}')" title="í´ë¦­ í¸ì§‘"><span class="mono" style="color:var(--accent);font-weight:700">${eq.num||dash}</span></span></td>
    <td style="text-align:center">${genBadge}</td>
    <td><span class="editable-cell" onclick="ie('${eq.id}','model','${escQ(eq.model||'')}')" title="í´ë¦­ í¸ì§‘">${eq.model||dash}</span></td>
    <td><span class="editable-cell" onclick="ieMonth('${eq.id}','buyMonth','${eq.buyMonth||''}')" title="í´ë¦­ í¸ì§‘">
      ${eq.buyMonth?`<span class="mth mth-buy">${eq.buyMonth}</span>`:dash}
      ${ageMos>0?`<div style="font-size:10px;color:var(--text3)">${ageStr} ê²½ê³¼</div>`:''}
    </span></td>
    <td><span class="editable-cell" onclick="ieDate('${eq.id}','installDate','${eq.installDate||''}')" title="í´ë¦­ í¸ì§‘">${eq.installDate?`<span class="mth mth-buy">${eq.installDate}</span>`:dash}</span></td>
    <td><span class="editable-cell" onclick="ieSel('${eq.id}','location',${JSON.stringify(lo)},'${eq.location||'ì—¬ë¶„'}')" title="í´ë¦­ í¸ì§‘">${eq.location||dash}</span></td>
    <td><span class="editable-cell" onclick="ieSel('${eq.id}','status',${JSON.stringify(st)},'${eq.status||'ì‚¬ìš©ì¤‘'}')" title="í´ë¦­ í¸ì§‘"><span class="badge ${sc[eq.status]||'b-gray'}">${eq.status||'-'}</span></span></td>
    <td><span class="editable-cell" onclick="ie('${eq.id}','note','${escQ(eq.note||'')}')" title="í´ë¦­ í¸ì§‘">${eq.note||dash}</span></td>
    <td><button class="btn btn-ghost btn-sm" onclick="openEditEquip('${eq.id}')">âœï¸</button></td>
    <td><button class="btn btn-danger btn-sm" onclick="openDiscardModal('${eq.id}')">ğŸ—‘ íê¸°</button></td>
  </tr>`;
}

function renderArchiveTable(list, area){
  if(!list.length){ area.innerHTML='<div class="empty-st">íê¸° ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  const sorted = [...list].sort((a,b)=>(b.discardMonth||'').localeCompare(a.discardMonth||''));
  area.innerHTML=`
    <div class="thead-row" style="border-radius:0;background:rgba(239,68,68,.06)">
      <div class="ttitle" style="color:var(--red)">ğŸ“¦ ${activeCat||'ì „ì²´'} â€” íê¸° ì´ë ¥ (${list.length}ëŒ€)</div>
      <div style="font-size:12px;color:var(--text3)">ë²ˆí˜¸ë³„ ì„¸ëŒ€ ì´ë ¥</div>
    </div>
    <div style="overflow-x:auto"><table class="equip-detail-table">
      <thead><tr>
        <th style="min-width:70px">ë²ˆí˜¸</th><th style="min-width:50px">ì„¸ëŒ€</th>
        <th style="min-width:140px">ì œì¡°ì‚¬/ëª¨ë¸</th><th style="min-width:90px">êµ¬ë§¤ì›”</th>
        <th style="min-width:90px">íê¸°ì›”</th><th style="min-width:80px">ì‚¬ìš©ê¸°ê°„</th>
        <th style="min-width:90px">ë§ˆì§€ë§‰ ìœ„ì¹˜</th><th style="min-width:130px">íê¸° ì‚¬ìœ </th>
        <th style="min-width:120px">ë©”ëª¨</th><th>ì‚­ì œ</th>
      </tr></thead>
      <tbody>${sorted.map(eq=>{
        const buyD  = eq.buyMonth    ? new Date(eq.buyMonth+'-01')    : null;
        const discD = eq.discardMonth? new Date(eq.discardMonth+'-01'): null;
        const usedMos = (buyD&&discD) ? Math.floor((discD-buyD)/1000/60/60/24/30) : null;
        const usedStr = usedMos!=null ? (usedMos>=12?(usedMos/12).toFixed(1)+'ë…„':usedMos+'ê°œì›”') : '-';
        const gen = eq.generation||1;
        const genBadge = `<span style="font-size:10px;background:rgba(239,68,68,.15);color:var(--red);border-radius:4px;padding:2px 6px;font-weight:700">${gen}ì„¸ëŒ€</span>`;
        const dash='<span style="color:var(--text3)">-</span>';
        return `<tr style="opacity:0.8">
          <td><span class="mono" style="color:var(--text3);font-weight:700">${eq.num||dash}</span></td>
          <td style="text-align:center">${genBadge}</td>
          <td>${eq.model||dash}</td>
          <td><span class="mth mth-buy">${eq.buyMonth||'-'}</span></td>
          <td><span class="mth mth-disc">${eq.discardMonth||'-'}</span></td>
          <td style="font-family:'IBM Plex Mono',monospace;font-weight:700;color:var(--text3)">${usedStr}</td>
          <td>${eq.location||dash}</td>
          <td style="color:var(--red)">${eq.discardReason||dash}</td>
          <td>${eq.note||dash}</td>
          <td><button class="btn btn-ghost btn-sm" onclick="delEquip('${eq.id}')">ğŸ—‘</button></td>
        </tr>`;
      }).join('')}</tbody>
    </table></div>`;
}

function renderEquipRow(eq){ return renderActiveRow(eq); }

// â”€â”€ íê¸° ì²˜ë¦¬ ëª¨ë‹¬ â”€â”€
let discardTargetId=null;
function openDiscardModal(eqId){
  const eq=equips.find(e=>e.id===eqId); if(!eq) return;
  discardTargetId=eqId;
  document.getElementById('em-id').value=eqId;
  document.getElementById('equip-modal-title').textContent=`ğŸ—‘ íê¸° ì²˜ë¦¬ â€” ${eq.itemName} #${eq.num||'?'}`;
  const itemSel=document.getElementById('em-item');
  itemSel.innerHTML=`<option>${eq.itemName}</option>`;
  itemSel.disabled=true;
  const numEl=document.getElementById('em-num');
  numEl.value=eq.num||''; numEl.readOnly=true;
  document.getElementById('em-model').value=eq.model||'';
  document.getElementById('em-buy').value=eq.buyMonth||'';
  document.getElementById('em-install').value=eq.installDate||'';
  document.getElementById('em-loc').value=eq.location||'ì—¬ë¶„';
  const stEl=document.getElementById('em-status');
  stEl.value='íê¸°'; stEl.disabled=true;
  document.getElementById('em-dmonth').value=nowMonth();
  document.getElementById('em-dreason').value='';
  document.getElementById('em-note').value=eq.note||'';
  document.getElementById('em-discard-grp').style.display='grid';
  const saveBtn=document.querySelector('#equip-modal .btn-primary');
  saveBtn.textContent='íê¸° ì €ì¥ â†’ ìƒˆ ì¥ë¹„ ë“±ë¡';
  saveBtn.onclick=saveDiscardAndReplace;
  openM('equip-modal');
}

function saveDiscardAndReplace(){
  const eqId=document.getElementById('em-id').value;
  const eq=equips.find(e=>e.id===eqId); if(!eq) return;
  eq.status='íê¸°';
  eq.discardMonth=document.getElementById('em-dmonth').value;
  eq.discardReason=document.getElementById('em-dreason').value;
  eq.note=document.getElementById('em-note').value;
  // em-item/status disabled ìƒíƒœ ì›ë³µ
  document.getElementById('em-item').disabled=false;
  document.getElementById('em-status').disabled=false;
  document.getElementById('em-num').readOnly=false;
  document.querySelector('#equip-modal .btn-primary').textContent='ì €ì¥';
  document.querySelector('#equip-modal .btn-primary').onclick=saveEquip;
  syncEquipToItems(); saveData();
  closeM('equip-modal');
  // ì„¸ëŒ€êµì²´ ëª¨ë‹¬
  const nextGen=(eq.generation||1)+1;
  document.getElementById('rp-item-name').value=eq.itemName;
  document.getElementById('rp-num').value=eq.num||'';
  document.getElementById('rp-generation').value=nextGen;
  document.getElementById('rp-model').value=eq.model||'';
  document.getElementById('rp-buy').value=nowMonth();
  document.getElementById('rp-install').value='';
  document.getElementById('rp-loc').value=eq.location||'ì—¬ì‚¬ B1';
  document.getElementById('rp-status').value='ì‚¬ìš©ì¤‘';
  document.getElementById('rp-note').value='';
  document.getElementById('replace-old-summary').innerHTML=`
    <div style="font-weight:700;color:var(--red);margin-bottom:6px">âœ… íê¸° ì™„ë£Œ: ${eq.itemName} #${eq.num||'?'} (${eq.generation||1}ì„¸ëŒ€)</div>
    <div style="font-size:12px;color:var(--text3)">êµ¬ë§¤: ${eq.buyMonth||'-'} &nbsp;Â·&nbsp; ìœ„ì¹˜: ${eq.location} &nbsp;Â·&nbsp; ì‚¬ìœ : ${eq.discardReason||'-'}</div>
    <div style="margin-top:8px;font-size:13px;color:var(--teal);font-weight:600">ğŸ‘‡ ê°™ì€ ë²ˆí˜¸(#${eq.num||'?'})ë¡œ <strong>${nextGen}ì„¸ëŒ€</strong> ìƒˆ ì¥ë¹„ë¥¼ ë“±ë¡í•˜ì„¸ìš”</div>`;
  openM('replace-modal');
  toast(`${eq.itemName} #${eq.num||'?'} íê¸° ì™„ë£Œ`,'ğŸ—‘');
}

function saveReplacement(){
  const itemName=document.getElementById('rp-item-name').value;
  const num=document.getElementById('rp-num').value;
  const gen=parseInt(document.getElementById('rp-generation').value)||2;
  const buyMonth=document.getElementById('rp-buy').value;
  if(!buyMonth){ toast('êµ¬ë§¤ì›”ì„ ì…ë ¥í•˜ì„¸ìš”','âš ï¸'); return; }
  equips.push({
    id:'e'+Date.now(), itemName, num, generation:gen,
    model:document.getElementById('rp-model').value,
    buyMonth,
    installDate:document.getElementById('rp-install').value,
    location:document.getElementById('rp-loc').value,
    status:document.getElementById('rp-status').value,
    discardMonth:'', discardReason:'',
    note:document.getElementById('rp-note').value
  });
  syncEquipToItems(); saveData();
  closeM('replace-modal');
  renderEquip(); renderDashboard();
  if(document.getElementById('page-items').classList.contains('active')) renderItems();
  toast(`${itemName} #${num} ${gen}ì„¸ëŒ€ ë“±ë¡ ì™„ë£Œ`,'âœ…');
}


// Inline edit helpers
function ie(eqId,field,cur,type='text'){
  const eq=equips.find(e=>e.id===eqId);if(!eq)return;
  const cell=event.currentTarget,orig=cell.innerHTML;
  cell.innerHTML=`<input class="inline-input" type="${type}" value="${cur}">`;
  const inp=cell.querySelector('input');inp.focus();inp.select();
  function commit(){eq[field]=type==='number'?(parseInt(inp.value)||0):inp.value;postEquipEdit(eq);}
  inp.addEventListener('blur',commit);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')cell.innerHTML=orig;});
}
function ieMonth(eqId,field,cur){
  const eq=equips.find(e=>e.id===eqId);if(!eq)return;
  const cell=event.currentTarget,orig=cell.innerHTML;
  cell.innerHTML=`<input class="inline-input" type="month" value="${cur}" style="width:130px">`;
  const inp=cell.querySelector('input');inp.focus();
  function commit(){eq[field]=inp.value;postEquipEdit(eq);}
  inp.addEventListener('blur',commit);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')cell.innerHTML=orig;});
}
function ieDate(eqId,field,cur){
  const eq=equips.find(e=>e.id===eqId);if(!eq)return;
  const cell=event.currentTarget,orig=cell.innerHTML;
  cell.innerHTML=`<input class="inline-input" type="date" value="${cur}" style="width:140px">`;
  const inp=cell.querySelector('input');inp.focus();
  function commit(){eq[field]=inp.value;postEquipEdit(eq);}
  inp.addEventListener('blur',commit);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape')cell.innerHTML=orig;});
}
function ieSel(eqId,field,opts,cur){
  const eq=equips.find(e=>e.id===eqId);if(!eq)return;
  const cell=event.currentTarget,orig=cell.innerHTML;
  cell.innerHTML=`<select class="inline-select">${opts.map(o=>`<option${o===cur?' selected':''}>${o}</option>`).join('')}</select>`;
  const sel=cell.querySelector('select');sel.focus();
  function commit(){eq[field]=sel.value;postEquipEdit(eq);}
  sel.addEventListener('blur',commit);
  sel.addEventListener('change',()=>setTimeout(()=>sel.blur(),50));
  sel.addEventListener('keydown',e=>{if(e.key==='Escape')cell.innerHTML=orig;});
}
function postEquipEdit(eq){syncEquipToItems();saveData();renderEquip();renderDashboard();toast('ì €ì¥ë¨','âœ…');}

// Equip add/edit
function openAddEquip(){
  document.getElementById('equip-modal-title').textContent='ì¥ë¹„ ë“±ë¡';
  document.getElementById('em-id').value='';
  document.getElementById('em-item').innerHTML=items.filter(i=>i.type==='equip').map(i=>`<option>${i.name}</option>`).join('');
  ['em-num','em-model','em-install','em-dmonth','em-dreason','em-note'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('em-buy').value=nowMonth();
  document.getElementById('em-loc').value='ì—¬ì‚¬ B1';
  document.getElementById('em-status').value='ì‚¬ìš©ì¤‘';
  document.getElementById('em-discard-grp').style.display='none';
  openM('equip-modal');
}
function openEditEquip(id){
  const eq=equips.find(e=>e.id===id);if(!eq)return;
  document.getElementById('equip-modal-title').textContent='ì¥ë¹„ í¸ì§‘';
  document.getElementById('em-id').value=id;
  document.getElementById('em-item').innerHTML=items.filter(i=>i.type==='equip').map(i=>`<option${i.name===eq.itemName?' selected':''}>${i.name}</option>`).join('');
  document.getElementById('em-num').value=eq.num||'';
  document.getElementById('em-model').value=eq.model||'';
  document.getElementById('em-buy').value=eq.buyMonth||'';
  document.getElementById('em-install').value=eq.installDate||'';
  document.getElementById('em-loc').value=eq.location||'ì—¬ì‚¬ B1';
  document.getElementById('em-status').value=eq.status||'ì‚¬ìš©ì¤‘';
  document.getElementById('em-dmonth').value=eq.discardMonth||'';
  document.getElementById('em-dreason').value=eq.discardReason||'';
  document.getElementById('em-note').value=eq.note||'';
  document.getElementById('em-discard-grp').style.display=eq.status==='íê¸°'?'grid':'none';
  openM('equip-modal');
}
function toggleDiscardFields(){
  const st=document.getElementById('em-status').value;
  document.getElementById('em-discard-grp').style.display=st==='íê¸°'?'grid':'none';
  if(st==='íê¸°'&&!document.getElementById('em-dmonth').value) document.getElementById('em-dmonth').value=nowMonth();
}
function saveEquip(){
  const itemName=document.getElementById('em-item').value;
  const editId=document.getElementById('em-id').value;
  const data={itemName,num:document.getElementById('em-num').value.trim(),model:document.getElementById('em-model').value,
    buyMonth:document.getElementById('em-buy').value,installDate:document.getElementById('em-install').value,
    location:document.getElementById('em-loc').value,status:document.getElementById('em-status').value,
    discardMonth:document.getElementById('em-dmonth').value,discardReason:document.getElementById('em-dreason').value,
    note:document.getElementById('em-note').value};
  if(editId){const idx=equips.findIndex(e=>e.id===editId);if(idx>-1)equips[idx]={...equips[idx],...data};toast(itemName+' ìˆ˜ì •ë¨','âœ…');}
  else{equips.push({id:'e'+Date.now(),...data});toast(itemName+' ë“±ë¡ë¨','âœ…');}
  syncEquipToItems();saveData();closeM('equip-modal');renderEquip();renderDashboard();
  if(document.getElementById('page-items').classList.contains('active'))renderItems();
}
function delEquip(id){
  const eq=equips.find(e=>e.id===id);
  if(!eq||!confirm(`"${eq.num||eq.model||'í•´ë‹¹'}" ì¥ë¹„ë¥¼ ì‚­ì œí• ê¹Œìš”?`))return;
  equips=equips.filter(e=>e.id!==id);syncEquipToItems();saveData();renderEquip();renderDashboard();toast('ì‚­ì œë¨','ğŸ—‘');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ITEM MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentItemType='equip';
function setItemType(t){
  currentItemType=t;
  document.getElementById('im-type').value=t;
  document.getElementById('type-equip-btn').className='type-btn'+(t==='equip'?' active-equip':'');
  document.getElementById('type-cons-btn').className='type-btn'+(t==='consumable'?' active-consumable':'');
  document.getElementById('im-equip-fields').style.display=t==='equip'?'block':'none';
  document.getElementById('im-cons-fields').style.display=t==='consumable'?'block':'none';
  document.getElementById('im-monthly-grp').style.opacity=t==='consumable'?'1':'0.4';
  // suggest category
  if(t==='consumable') document.getElementById('im-cat').value='ì†Œëª¨í’ˆ';
  else document.getElementById('im-cat').value='ì „ê¸°ìš©í’ˆ';
}
function openAddItem(){
  document.getElementById('item-modal-title').textContent='í’ˆëª© ì¶”ê°€';
  document.getElementById('im-id').value='';
  document.getElementById('im-name').value='';
  document.getElementById('im-min').value='10';
  document.getElementById('im-monthly').value='0';
  document.getElementById('im-stock').value='0';
  document.getElementById('im-unit').value='ê°œ';
  document.getElementById('im-note').value='';
  setItemType('equip');
  openM('item-modal');
}
function openEditItem(id){
  const item=items.find(i=>i.id===id);if(!item)return;
  document.getElementById('item-modal-title').textContent='í’ˆëª© í¸ì§‘';
  document.getElementById('im-id').value=id;
  document.getElementById('im-name').value=item.name;
  document.getElementById('im-cat').value=item.category;
  document.getElementById('im-min').value=item.minStock;
  document.getElementById('im-monthly').value=item.monthlyUsage||0;
  document.getElementById('im-stock').value=item.stock||0;
  document.getElementById('im-unit').value=item.unit||'ê°œ';
  document.getElementById('im-note').value=item.note||'';
  setItemType(item.type||'equip');
  openM('item-modal');
}
function saveItem(){
  const name=document.getElementById('im-name').value.trim();
  if(!name){toast('í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”','âš ï¸');return;}
  const type=document.getElementById('im-type').value;
  const data={
    name,type,category:document.getElementById('im-cat').value,
    minStock:parseInt(document.getElementById('im-min').value)||0,
    monthlyUsage:parseInt(document.getElementById('im-monthly').value)||0,
    unit:document.getElementById('im-unit').value||'ê°œ',
    note:document.getElementById('im-note').value
  };
  if(type==='consumable') data.stock=parseInt(document.getElementById('im-stock').value)||0;
  else{data.fb1=0;data.fb2=0;data.mb1=0;data.mb2=0;data.sup=0;data.emp=0;data.spare=0;data.repair=0;data.discard=0;}
  const editId=document.getElementById('im-id').value;
  if(editId){
    const idx=items.findIndex(i=>i.id==editId);
    items[idx]={...items[idx],...data};
    toast(name+' ìˆ˜ì •ë¨','âœ…');
  }else{
    items.push({id:nextItemId++,...data});
    toast(name+' ì¶”ê°€ë¨','âœ…');
  }
  saveData();closeM('item-modal');
  renderDashboard();renderItems();renderManage();
  if(document.getElementById('page-equipment').classList.contains('active'))renderEquip();
}
function deleteItem(id){
  const item=items.find(i=>i.id===id);
  if(!item||!confirm(`"${item.name}" í’ˆëª©ì„ ì‚­ì œí• ê¹Œìš”?`))return;
  items=items.filter(i=>i.id!==id);saveData();toast(item.name+' ì‚­ì œë¨','ğŸ—‘');
  renderManage();renderDashboard();renderItems();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QTY ADJUST (ì¥ë¹„ìš©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openQty(id){
  const item=items.find(i=>i.id===id);if(!item)return;
  document.getElementById('qa-id').value=id;
  document.getElementById('qty-modal-title').textContent=item.name+' â€” ìˆ˜ëŸ‰ ì¡°ì •';
  document.getElementById('qa-qty').value=0;document.getElementById('qa-reason').value='';
  openM('qty-modal');
}
function saveQty(){
  const id=parseInt(document.getElementById('qa-id').value);
  const item=items.find(i=>i.id===id);if(!item)return;
  const loc=document.getElementById('qa-loc').value,type=document.getElementById('qa-type').value;
  const qty=parseInt(document.getElementById('qa-qty').value)||0;
  if(type==='set')item[loc]=qty;else if(type==='add')item[loc]+=qty;else item[loc]=Math.max(0,item[loc]-qty);
  saveData();closeM('qty-modal');renderItems();renderDashboard();toast(item.name+' ìˆ˜ëŸ‰ ì¡°ì •ë¨','âœ…');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MANAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderManage(){
  document.getElementById('manage-tbody').innerHTML=items.map(item=>{
    const typeB=item.type==='equip'?'<span class="badge b-info">ì¥ë¹„</span>':'<span class="badge b-orange">ì†Œëª¨í’ˆ</span>';
    const stockVal = item.type==='equip' ? getEquipActive(item) : (item.stock||0);
    const stockColor = stockVal < item.minStock ? 'var(--orange)' : 'var(--green)';
    const totalVal = item.type==='equip' ? getEquipTotal(item) : '-';
    return `<tr class="${item.type==='equip'?'tr-equip':'tr-consumable'}">
      <td>${typeB}</td>
      <td><strong>${item.name}</strong></td>
      <td><span class="badge b-info">${item.category}</span></td>
      <td style="font-weight:700;color:${stockColor};font-family:'IBM Plex Mono',monospace">
        ${stockVal} ${item.unit||'ê°œ'}
        ${item.type==='equip'?`<div style="font-size:10px;color:var(--text3);font-weight:400">ì „ì²´ ${totalVal} Â· ìˆ˜ë¦¬ ${item.repair||0} Â· íê¸° ${item.discard||0}</div>`:''}
      </td>
      <td>${item.minStock} ${item.unit||'ê°œ'}</td>
      <td>${item.monthlyUsage||0} ${item.unit||'ê°œ'}</td>
      <td style="color:var(--text2);font-size:12px">${item.note||'-'}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-ghost btn-sm" onclick="openEditItem(${item.id})">í¸ì§‘</button>
        <button class="btn btn-danger btn-sm" onclick="deleteItem(${item.id})">ì‚­ì œ</button>
      </td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];

function getMonthKey(year,m){return `${year}-${String(m).padStart(2,'0')}`;}

// íŠ¹ì • ì›”ì˜ ì†Œëª¨í’ˆ ì‹¤ì œ ì¶œê³ ëŸ‰ í•©ì‚°
function getMonthlyOut(itemId, monthKey){
  return consLogs.filter(l=>l.itemId===itemId && l.type==='out' && (l.date||'').startsWith(monthKey)).reduce((s,l)=>s+l.qty,0);
}
function getMonthlyIn(itemId, monthKey){
  return consLogs.filter(l=>l.itemId===itemId && l.type==='in'  && (l.date||'').startsWith(monthKey)).reduce((s,l)=>s+l.qty,0);
}

function renderAnalytics(){
  const year = parseInt(document.getElementById('an-year')?.value || new Date().getFullYear());
  const consItems = items.filter(i=>i.type==='consumable');

  // â”€â”€ ì—°ê°„ ìš”ì•½ ìŠ¤íƒ¯ â”€â”€
  const yearVisitors = Array.from({length:12},(_,m)=>visitors[getMonthKey(year,m+1)]||0);
  const totalVisitors = yearVisitors.reduce((a,b)=>a+b,0);
  const activeMonths  = yearVisitors.filter(v=>v>0).length;
  const avgVisitors   = activeMonths ? Math.round(totalVisitors/activeMonths) : 0;
  const peakMonth     = yearVisitors.indexOf(Math.max(...yearVisitors));
  const totalOut      = consItems.reduce((s,item)=>s+Array.from({length:12},(_,m)=>getMonthlyOut(item.id,getMonthKey(year,m+1))).reduce((a,b)=>a+b,0),0);

  document.getElementById('an-stat-grid').innerHTML=`
    <div class="stat-card" style="--cc:var(--teal)">
      <div class="stat-lbl">ì—°ê°„ ì´ ì…ì¥ê°</div>
      <div class="stat-val">${totalVisitors.toLocaleString()}</div>
      <div class="stat-sub">${year}ë…„ ëˆ„ì </div>
    </div>
    <div class="stat-card" style="--cc:var(--accent)">
      <div class="stat-lbl">ì›”í‰ê·  ì…ì¥ê°</div>
      <div class="stat-val">${avgVisitors.toLocaleString()}</div>
      <div class="stat-sub">${activeMonths}ê°œì›” ì§‘ê³„</div>
    </div>
    <div class="stat-card" style="--cc:var(--yellow)">
      <div class="stat-lbl">ìµœì„±ìˆ˜ê¸°</div>
      <div class="stat-val" style="font-size:22px">${peakMonth>=0&&yearVisitors[peakMonth]>0?MONTHS[peakMonth]:'ì—†ìŒ'}</div>
      <div class="stat-sub">${yearVisitors[peakMonth]>0?(yearVisitors[peakMonth].toLocaleString()+'ëª…'):'-'}</div>
    </div>
    <div class="stat-card" style="--cc:var(--orange)">
      <div class="stat-lbl">ì†Œëª¨í’ˆ ì—°ê°„ ì¶œê³ </div>
      <div class="stat-val">${totalOut.toLocaleString()}</div>
      <div class="stat-sub">${consItems.length}ì¢… í•©ì‚°</div>
    </div>
  `;

  // â”€â”€ ì›”ë³„ ë§‰ëŒ€ ì°¨íŠ¸ (ì…ì¥ê° + ì†Œëª¨í’ˆ) â”€â”€
  const maxVis = Math.max(...yearVisitors,1);
  const CHART_H = 140;
  // ëŒ€í‘œ ì†Œëª¨í’ˆ 1ê°œ ì¶œê³ ëŸ‰ìœ¼ë¡œ ë¹„êµ (ì²«ë²ˆì§¸ ì†Œëª¨í’ˆ)
  const repItem = consItems[0];
  const monthlyOutArr = repItem ? Array.from({length:12},(_,m)=>getMonthlyOut(repItem.id,getMonthKey(year,m+1))) : [];
  const maxOut = Math.max(...monthlyOutArr,1);

  let barsHTML = Array.from({length:12},(_,m)=>{
    const vis = yearVisitors[m]||0;
    const visH = Math.round((vis/maxVis)*CHART_H);
    const out  = monthlyOutArr[m]||0;
    const outH = Math.round((out/maxOut)*(CHART_H*0.7));
    const curM = getMonthKey(year,m+1);
    const isFuture = curM > nowMonth();
    return `<div class="bar-col">
      <div style="position:relative;height:${CHART_H}px;display:flex;align-items:flex-end;gap:3px;">
        <div style="width:18px;height:${visH}px;background:${isFuture?'rgba(45,212,191,.2)':'var(--teal)'};border-radius:3px 3px 0 0;position:relative;">
          ${vis>0?`<span style="position:absolute;top:-16px;left:50%;transform:translateX(-50%);font-size:9px;color:var(--teal);white-space:nowrap;font-family:'IBM Plex Mono',monospace">${(vis/1000).toFixed(1)}k</span>`:''}
        </div>
        ${repItem?`<div style="width:18px;height:${outH}px;background:${isFuture?'rgba(251,146,60,.2)':'var(--orange)'};border-radius:3px 3px 0 0;"></div>`:''}
      </div>
      <div class="bar-lbl">${MONTHS[m]}</div>
    </div>`;
  }).join('');

  document.getElementById('an-monthly-chart').innerHTML=`
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px;">
      <div class="legend-item"><div class="legend-dot" style="background:var(--teal)"></div> ì…ì¥ê° ìˆ˜</div>
      ${repItem?`<div class="legend-item"><div class="legend-dot" style="background:var(--orange)"></div> ${repItem.name} ì†Œëª¨ëŸ‰</div>`:''}
    </div>
    <div class="bar-chart">${barsHTML}</div>
    <div style="margin-top:10px;">
      <table style="width:100%;font-size:12px;border-collapse:collapse;">
        <thead><tr style="border-bottom:1px solid var(--border)">
          <th style="padding:6px 8px;text-align:left;color:var(--text3);font-size:11px">ì›”</th>
          ${MONTHS.map(m=>`<th style="padding:6px 8px;text-align:center;color:var(--text3);font-size:11px">${m}</th>`).join('')}
        </tr></thead>
        <tbody>
          <tr style="border-bottom:1px solid var(--border)">
            <td style="padding:6px 8px;color:var(--teal);font-weight:700;font-size:11px">ì…ì¥ê°</td>
            ${yearVisitors.map((v,m)=>{
              const k=getMonthKey(year,m+1),isFuture=k>nowMonth();
              return `<td style="padding:6px 8px;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:11px;color:${v>0?'var(--teal)':'var(--text3)'};${isFuture?'opacity:0.4':''}">${v>0?v.toLocaleString():'-'}</td>`;
            }).join('')}
          </tr>
          ${consItems.map(item=>{
            const outs = Array.from({length:12},(_,m)=>getMonthlyOut(item.id,getMonthKey(year,m+1)));
            // 1ì¸ë‹¹ ì†Œëª¨ëŸ‰ (ì†Œëª¨ ê¸°ì¤€)
            const perCapita = Array.from({length:12},(_,m)=>{
              const vis=yearVisitors[m]||0;
              const out=getMonthlyOut(item.id,getMonthKey(year,m+1));
              return (vis>0&&out>0)?(out/vis):null;
            });
            return `
            <tr style="border-bottom:1px solid rgba(255,255,255,0.04)">
              <td style="padding:6px 8px;color:var(--orange);font-size:11px;font-weight:600">${item.name}<span style="font-size:10px;color:var(--text3);margin-left:4px">ì†Œëª¨</span></td>
              ${outs.map((v,m)=>{
                const bg = v>0?`rgba(251,146,60,${Math.min(0.8,v/(item.monthlyUsage||1)*0.5+0.1)})`:''  ;
                return `<td style="padding:6px 8px;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:11px;background:${bg};border-radius:3px">${v>0?v:'-'}</td>`;
              }).join('')}
            </tr>
            <tr style="border-bottom:1px solid var(--border)">
              <td style="padding:4px 8px 8px 16px;color:var(--text3);font-size:10px">â†³ 1ì¸ë‹¹ ì†Œëª¨</td>
              ${perCapita.map((v,m)=>{
                const isFuture=getMonthKey(year,m+1)>nowMonth();
                if(v===null) return `<td style="padding:4px 8px 8px;text-align:center;font-size:10px;color:var(--text3)">-</td>`;
                const intensity=Math.min(0.7,v*20+0.1);
                return `<td style="padding:4px 8px 8px;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--yellow);${isFuture?'opacity:0.4':''}"
                  title="${item.name} ${getMonthKey(year,m+1)}: ì…ì¥ê° ${(yearVisitors[m]||0).toLocaleString()}ëª… ì¤‘ ${getMonthlyOut(item.id,getMonthKey(year,m+1))}${item.unit||'ê°œ'} ì†Œëª¨">
                  ${v.toFixed(4)}
                </td>`;
              }).join('')}
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;

  // â”€â”€ 1ì¸ë‹¹ ì†Œëª¨ëŸ‰ ë¶„ì„ (ì „ì²´ ê¸°ê°„ ê¸°ë°˜) â”€â”€
  // visitors ì „ì²´ í‚¤ì—ì„œ ì†Œëª¨ëŸ‰/ì…ì¥ê° ê°€ì¤‘í‰ê·  ê³„ì‚°
  const allVisitorMonths = Object.keys(visitors).filter(k=>visitors[k]>0);
  const allTotalVisitors = allVisitorMonths.reduce((s,k)=>s+(visitors[k]||0),0);

  document.getElementById('an-perhead-tbody').innerHTML = consItems.map(item=>{
    // ì „ì²´ ê¸°ê°„ ê°€ì¤‘í‰ê·  1ì¸ë‹¹ ì†Œëª¨ëŸ‰
    const monthData = allVisitorMonths.map(k=>({
      vis: visitors[k]||0,
      out: getMonthlyOut(item.id, k)
    })).filter(d=>d.vis>0 && d.out>0);

    const allTotalOut = monthData.reduce((s,d)=>s+d.out,0);
    const allTotalVis = monthData.reduce((s,d)=>s+d.vis,0);
    const actualPerHead = allTotalVis>0 ? allTotalOut/allTotalVis : 0;
    const dataMonths = monthData.length;

    const setPerHead = perHead[item.id] ?? (item.monthlyUsage && avgVisitors ? item.monthlyUsage/avgVisitors : 0);
    const diff = actualPerHead - setPerHead;
    const accuracy = setPerHead>0 ? Math.max(0,Math.min(100,100-Math.abs(diff/setPerHead)*100)) : 0;
    const accColor = accuracy>=80?'var(--green)':accuracy>=60?'var(--yellow)':'var(--red)';
    return `<tr>
      <td><strong>${item.name}</strong><br><span style="font-size:11px;color:var(--text3)">${item.unit||'ê°œ'}/ì¸</span></td>
      <td>
        <input type="number" value="${setPerHead.toFixed(4)}" step="0.0001" min="0"
          style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px;color:var(--text);width:90px;font-family:'IBM Plex Mono',monospace;outline:none;"
          onchange="perHead[${item.id}]=parseFloat(this.value)||0;saveData();renderAnalytics();"
          title="ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥">
        <div style="font-size:10px;color:var(--text3);margin-top:2px">ìˆ˜ë™ ì„¤ì •ê°’</div>
      </td>
      <td>
        <span style="font-family:'IBM Plex Mono',monospace;font-weight:700;color:${dataMonths>0?'var(--green)':'var(--text3)'}">${dataMonths>0?actualPerHead.toFixed(4):'-'}</span>
        ${dataMonths>0
          ? `<div style="font-size:10px;color:var(--text3);margin-top:2px">${dataMonths}ê°œì›” Â· ${allTotalVis.toLocaleString()}ëª… ê¸°ë°˜</div>`
          : '<div style="font-size:10px;color:var(--text3)">ì†Œëª¨ ì´ë ¥ ì—†ìŒ</div>'}
      </td>
      <td>
        ${dataMonths>0?(()=>{const dc=diff>0?'var(--red)':diff<0?'var(--green)':'var(--text2)';const sign=diff>=0?'+':'';return `<span style="color:${dc};font-weight:700;font-family:'IBM Plex Mono',monospace">${sign}${diff.toFixed(4)}</span>`;})():'-'}
      </td>
      <td>
        <div style="font-size:13px;font-weight:700;color:${accColor}">${dataMonths>0?accuracy.toFixed(0)+'%':'-'}</div>
        <div class="accuracy-bar"><div class="accuracy-fill" style="width:${accuracy}%;background:${accColor}"></div></div>
      </td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="autoCalcPerHead(${item.id})">ìë™ ê³„ì‚° ì ìš©</button>
      </td>
    </tr>`;
  }).join('') || '<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--text3)">ì†Œëª¨í’ˆ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';

  // â”€â”€ êµ¬ë§¤ëŸ‰ ê³„ì‚°ê¸° â”€â”€
  const nm = new Date(); nm.setMonth(nm.getMonth()+1);
  const nextY = nm.getFullYear(), nextM = nm.getMonth()+1;
  document.getElementById('an-next-month-title').textContent = `êµ¬ë§¤ëŸ‰ ê³„ì‚°ê¸°`;

  // ëŒ€ìƒ ì›” ì´ˆê¸°ê°’ ì„¤ì •
  const targetMonthEl = document.getElementById('an-target-month');
  if(targetMonthEl && !targetMonthEl.value){
    targetMonthEl.value = `${nextY}-${String(nextM).padStart(2,'0')}`;
  }
  const targetMonthVal = targetMonthEl?.value || `${nextY}-${String(nextM).padStart(2,'0')}`;
  const [tYear, tMonth] = targetMonthVal.split('-').map(Number);

  const inputVis = parseInt(document.getElementById('an-next-visitors')?.value)||0;

  // ìë™ ì˜ˆì¸¡: ì „ë…„ ë™ì›” â†’ ì—†ìœ¼ë©´ ìµœê·¼ 3ê°œì›” í‰ê· 
  let autoVis = 0, autoVisSource = '';
  const prevYearKey = getMonthKey(tYear-1, tMonth);
  if(visitors[prevYearKey]){
    autoVis = visitors[prevYearKey];
    autoVisSource = `ì „ë…„ ë™ì›”(${tYear-1}ë…„ ${tMonth}ì›”) ì‹¤ì  ê¸°ì¤€`;
  } else {
    const recent=[1,2,3].map(d=>{const nd=new Date(tYear,tMonth-1-d,1);return visitors[getMonthKey(nd.getFullYear(),nd.getMonth()+1)]||0;});
    const nonzero=recent.filter(v=>v>0);
    autoVis = nonzero.length ? Math.round(nonzero.reduce((a,b)=>a+b,0)/nonzero.length) : avgVisitors;
    autoVisSource = nonzero.length ? `ìµœê·¼ ${nonzero.length}ê°œì›” í‰ê·  ê¸°ì¤€` : 'ì—°ê°„ ì›”í‰ê·  ê¸°ì¤€';
  }
  const predictVis = inputVis || autoVis;

  // ë°°ë„ˆ
  const bannerEl = document.getElementById('an-predict-banner');
  if(bannerEl){
    const visDisp = predictVis.toLocaleString();
    const src = inputVis ? 'ì§ì ‘ ì…ë ¥' : `ìë™ ì¶”ì²œ (${autoVisSource})`;
    bannerEl.innerHTML = `
      ğŸ“Š <strong>${tYear}ë…„ ${tMonth}ì›”</strong> ê¸°ì¤€ &nbsp;|&nbsp;
      ì˜ˆìƒ ì…ì¥ê° <strong style="color:var(--teal);font-size:14px">${visDisp}ëª…</strong>
      <span style="color:var(--text3);margin-left:6px">(${src})</span>
      ${!inputVis ? `&nbsp;Â·&nbsp; <span style="color:var(--text3)">ì…ì¥ê° ìˆ˜ë¥¼ ì§ì ‘ ì…ë ¥í•˜ë©´ ë” ì •í™•í•œ ê³„ì‚°ì´ ë©ë‹ˆë‹¤</span>` : ''}
    `;
  }

  // â”€â”€ 1ì¸ë‹¹ ì†Œëª¨ëŸ‰: ì „ì²´ ê¸°ê°„ ë°ì´í„° ê¸°ë°˜ ê³„ì‚° â”€â”€
  // ì„ íƒ ì—°ë„ê°€ ì•„ë‹Œ visitorsì— ìˆëŠ” ëª¨ë“  ì›” ë°ì´í„°ë¥¼ í™œìš©
  const getActualPerCapita = (item) => {
    // visitors ì „ì²´ í‚¤ ìˆœíšŒ (ì˜ˆ: "2025-01", "2025-02" ...)
    const allMonths = Object.keys(visitors).filter(k=>visitors[k]>0);
    const monthsWithData = allMonths.map(monthKey=>{
      const vis = visitors[monthKey]||0;
      const out = getMonthlyOut(item.id, monthKey);
      return (vis>0 && out>0) ? {ratio: out/vis, vis, out, monthKey} : null;
    }).filter(v=>v!==null);

    if(monthsWithData.length===0) return null;

    // ê°€ì¤‘í‰ê· : ì…ì¥ê° ìˆ˜ ë§ì€ ë‹¬ì— ë” í° ë¹„ì¤‘
    const totalVis = monthsWithData.reduce((s,d)=>s+d.vis,0);
    const weighted = monthsWithData.reduce((s,d)=>s+(d.ratio*d.vis),0)/totalVis;
    return { value: weighted, months: monthsWithData.length, totalVis };
  };

  // ì¹´ë“œ ë Œë”ë§
  const cardsEl = document.getElementById('an-predict-cards');
  if(cardsEl){
    cardsEl.innerHTML = consItems.map(item=>{
      const pcResult  = getActualPerCapita(item);
      const setPC     = perHead[item.id] ?? (item.monthlyUsage && avgVisitors ? item.monthlyUsage/avgVisitors : 0);
      const usePC     = pcResult ? pcResult.value : setPC;
      const pcSource  = pcResult ? `ì‹¤ì¸¡ (${pcResult.months}ê°œì›” / ${pcResult.totalVis.toLocaleString()}ëª… ê¸°ë°˜)` : 'ì„¤ì •ê°’';
      const pcColor   = pcResult ? 'var(--green)' : 'var(--text3)';

      const predictOut  = Math.round(predictVis * usePC);
      const curStock    = item.stock || 0;
      const shortage    = Math.max(0, predictOut - curStock);
      const recommend   = shortage + Math.round(predictOut * 0.1);
      const surplus     = Math.max(0, curStock - predictOut);

      const statusColor = shortage > 0 ? 'var(--red)' : 'var(--green)';
      const statusLabel = shortage > 0
        ? `<span style="color:var(--red);font-weight:700">âš  ì¬ê³  ë¶€ì¡± ì˜ˆìƒ</span>`
        : `<span style="color:var(--green);font-weight:700">âœ“ ì¬ê³  ì¶©ë¶„</span>`;

      return `
      <div style="background:var(--surface);padding:18px 20px;">
        <!-- í’ˆëª©ëª… -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
          <div>
            <div style="font-size:15px;font-weight:700;color:var(--text)">${item.name}</div>
            <div style="font-size:11px;color:var(--text3);margin-top:2px">ë‹¨ìœ„: ${item.unit||'ê°œ'}</div>
          </div>
          ${statusLabel}
        </div>

        <!-- í•µì‹¬ ìˆ˜ì¹˜ 3ì¹¸ -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
          <div style="background:var(--surface2);border-radius:8px;padding:10px;text-align:center">
            <div style="font-size:10px;color:var(--text3);margin-bottom:4px">1ì¸ë‹¹ ì†Œëª¨</div>
            <div style="font-size:16px;font-weight:700;color:${pcColor};font-family:'IBM Plex Mono',monospace">${usePC>0?usePC.toFixed(4):'-'}</div>
            <div style="font-size:10px;color:var(--text3);margin-top:2px">${item.unit||'ê°œ'}/ì¸ (${pcSource})</div>
          </div>
          <div style="background:rgba(251,146,60,.1);border-radius:8px;padding:10px;text-align:center;border:1px solid rgba(251,146,60,.2)">
            <div style="font-size:10px;color:var(--orange);margin-bottom:4px">ì˜ˆìƒ ì†Œëª¨ëŸ‰</div>
            <div style="font-size:20px;font-weight:700;color:var(--orange);font-family:'IBM Plex Mono',monospace">${predictOut.toLocaleString()}</div>
            <div style="font-size:10px;color:var(--text3);margin-top:2px">${predictVis.toLocaleString()}ëª… Ã— ${usePC.toFixed(4)}</div>
          </div>
          <div style="background:var(--surface2);border-radius:8px;padding:10px;text-align:center">
            <div style="font-size:10px;color:var(--text3);margin-bottom:4px">í˜„ì¬ ì¬ê³ </div>
            <div style="font-size:20px;font-weight:700;color:var(--text);font-family:'IBM Plex Mono',monospace">${curStock.toLocaleString()}</div>
            <div style="font-size:10px;color:var(--text3);margin-top:2px">${item.unit||'ê°œ'} ë³´ìœ </div>
          </div>
        </div>

        <!-- êµ¬ë¶„ì„  -->
        <div style="border-top:1px solid var(--border);margin-bottom:12px"></div>

        <!-- ê¶Œì¥ êµ¬ë§¤ëŸ‰ -->
        ${shortage > 0 ? `
        <div style="display:flex;justify-content:space-between;align-items:center;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:10px 14px">
          <div>
            <div style="font-size:11px;color:var(--red)">ë¶€ì¡± ì˜ˆìƒ Â· ê¶Œì¥ êµ¬ë§¤ëŸ‰</div>
            <div style="font-size:10px;color:var(--text3);margin-top:2px">ë¶€ì¡±ë¶„ ${shortage}${item.unit||'ê°œ'} + ì—¬ìœ  10%</div>
          </div>
          <div style="font-size:24px;font-weight:700;color:var(--red);font-family:'IBM Plex Mono',monospace">+${recommend.toLocaleString()} <span style="font-size:13px">${item.unit||'ê°œ'}</span></div>
        </div>
        ` : `
        <div style="display:flex;justify-content:space-between;align-items:center;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:8px;padding:10px 14px">
          <div>
            <div style="font-size:11px;color:var(--green)">ì¬ê³  ì¶©ë¶„ Â· ì—¬ìœ ë¶„</div>
            <div style="font-size:10px;color:var(--text3);margin-top:2px">ì˜ˆìƒ ì†Œëª¨ í›„ ${surplus}${item.unit||'ê°œ'} ë‚¨ìŒ</div>
          </div>
          <div style="font-size:20px;font-weight:700;color:var(--green);font-family:'IBM Plex Mono',monospace">êµ¬ë§¤ ë¶ˆí•„ìš”</div>
        </div>
        `}

        ${usePC===0 ? `<div style="margin-top:8px;font-size:11px;color:var(--yellow)">âš  1ì¸ë‹¹ ì†Œëª¨ëŸ‰ ë°ì´í„° ì—†ìŒ â€” ì†Œëª¨ ì´ë ¥ì„ ì…ë ¥í•˜ë©´ ì „ì²´ ê¸°ê°„ ê¸°ë°˜ìœ¼ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</div>` : ''}
      </div>`;
    }).join('') || `<div style="padding:32px;text-align:center;color:var(--text3);grid-column:1/-1">ì†Œëª¨í’ˆ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
  }

  // êµ¬ predict-tbody í˜¸í™˜ (í˜¹ì‹œ ì°¸ì¡°í•˜ëŠ” ì½”ë“œê°€ ìˆìœ¼ë©´ ë¹ˆ ì²˜ë¦¬)
  const oldTbody = document.getElementById('an-predict-tbody');
  if(oldTbody) oldTbody.innerHTML='';

  // â”€â”€ ì›”ë³„ ìƒì„¸ í…Œì´ë¸” â”€â”€
  document.getElementById('an-detail-head').innerHTML =
    `<th style="padding:9px 14px;font-size:11px;font-weight:700;color:var(--text3);background:var(--surface2)">í•­ëª©</th>`+
    MONTHS.map(m=>`<th style="padding:9px 14px;font-size:11px;font-weight:700;color:var(--text3);background:var(--surface2);text-align:center;min-width:70px">${m}</th>`).join('');

  const detailRows = [];
  // ì…ì¥ê° í–‰
  detailRows.push(`<tr class="an-table-row-visitor">
    <td style="padding:10px 14px;font-weight:700;color:var(--teal)">ğŸ‘¥ ì…ì¥ê°</td>
    ${yearVisitors.map((v,m)=>{
      const k=getMonthKey(year,m+1);
      return `<td style="padding:10px 14px;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700;color:${v?'var(--teal)':'var(--text3)'}">
        <input type="number" value="${v||''}" placeholder="-" min="0"
          style="background:transparent;border:none;border-bottom:1px solid ${v?'var(--teal)':'var(--border)'};color:${v?'var(--teal)':'var(--text3)'};width:65px;text-align:center;font-size:12px;font-family:'IBM Plex Mono',monospace;outline:none;padding:2px;"
          onchange="visitors['${k}']=parseInt(this.value)||0;saveData();renderAnalytics();">
      </td>`;
    }).join('')}
  </tr>`);

  consItems.forEach(item=>{
    const outs = Array.from({length:12},(_,m)=>getMonthlyOut(item.id,getMonthKey(year,m+1)));
    const ins  = Array.from({length:12},(_,m)=>getMonthlyIn(item.id,getMonthKey(year,m+1)));
    const maxOut2 = Math.max(...outs,1);
    detailRows.push(`<tr>
      <td style="padding:10px 14px;font-weight:600">${item.name}<br><span style="font-size:11px;color:var(--text3)">ì¶œê³ ëŸ‰</span></td>
      ${outs.map((v,m)=>{
        const intensity=Math.min(0.8,v/maxOut2*0.7+0.05);
        const bg=v>0?`rgba(251,146,60,${intensity})`:'';
        return `<td style="padding:8px 14px;text-align:center;background:${bg};font-family:'IBM Plex Mono',monospace;font-size:12px">${v||'-'}</td>`;
      }).join('')}
    </tr>`);
    detailRows.push(`<tr style="border-bottom:1px solid var(--border)">
      <td style="padding:6px 14px 10px;color:var(--green);font-size:12px">â†‘ ì…ê³ ëŸ‰</td>
      ${ins.map(v=>`<td style="padding:6px 14px 10px;text-align:center;color:${v?'var(--green)':'var(--text3)'};font-family:'IBM Plex Mono',monospace;font-size:12px">${v||'-'}</td>`).join('')}
    </tr>`);
    // 1ì¸ë‹¹ í–‰
    const phArr = yearVisitors.map((vis,m)=>{
      const out=outs[m];
      return vis>0&&out>0?(out/vis).toFixed(3):'-';
    });
    detailRows.push(`<tr style="border-bottom:2px solid var(--border)">
      <td style="padding:6px 14px 12px;color:var(--text3);font-size:11px">1ì¸ë‹¹ ì†Œëª¨</td>
      ${phArr.map(v=>`<td style="padding:6px 14px 12px;text-align:center;color:var(--purple);font-family:'IBM Plex Mono',monospace;font-size:11px">${v}</td>`).join('')}
    </tr>`);
  });

  document.getElementById('an-detail-tbody').innerHTML = detailRows.join('');

  // â”€â”€ ì¥ë¹„ ë¶„ì„ ë Œë”ë§ â”€â”€
  renderEquipAnalytics();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EQUIP ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEquipAnalytics(){
  const LOCATIONS = ['ì—¬ì‚¬ B1','ì—¬ì‚¬ B2','ë‚¨ì‚¬ B1','ë‚¨ì‚¬ B2','ì§€ì›íŒ€','ì§ì›ìš©','ì—¬ë¶„'];
  const LOC_KEYS  = ['fb1','fb2','mb1','mb2','sup','emp','spare'];
  const equipItems = items.filter(i=>i.type==='equip');
  const now = new Date();

  // â”€â”€ â‘  ìƒíƒœ ì´ìƒ ì•Œë¦¼ â”€â”€
  const alerts = [];
  equips.forEach(eq=>{
    const item = equipItems.find(i=>i.name===eq.itemName);
    if(!item) return;
    const ageMos = eq.buyMonth ? Math.floor((now - new Date(eq.buyMonth+'-01'))/1000/60/60/24/30) : 0;
    const ageYrs = (ageMos/12).toFixed(1);
    if(eq.status==='ìˆ˜ë¦¬ì¤‘')
      alerts.push({level:'warn', icon:'ğŸ”§', msg:`<strong>${eq.itemName} #${eq.num||'?'}</strong> ìˆ˜ë¦¬ ì¤‘ â€” ${eq.note||'ì‚¬ìœ  ë¯¸ê¸°ì¬'}`, sub:`${eq.location} Â· êµ¬ë§¤ ${ageYrs}ë…„ ê²½ê³¼`});
    if(ageMos>=60 && eq.status==='ì‚¬ìš©ì¤‘')
      alerts.push({level:'caution', icon:'â°', msg:`<strong>${eq.itemName} #${eq.num||'?'}</strong> 5ë…„ ì´ìƒ ë…¸í›„ ì¥ë¹„`, sub:`êµ¬ë§¤ ${eq.buyMonth||'ë¯¸ê¸°ì¬'} (${ageYrs}ë…„) Â· ${eq.location}`});
    if(ageMos>=84 && eq.status==='ì‚¬ìš©ì¤‘')
      alerts.push({level:'danger', icon:'ğŸš¨', msg:`<strong>${eq.itemName} #${eq.num||'?'}</strong> 7ë…„ ì´ˆê³¼ â€” êµì²´ ê°•ë ¥ ê¶Œì¥`, sub:`êµ¬ë§¤ ${eq.buyMonth||'ë¯¸ê¸°ì¬'} (${ageYrs}ë…„) Â· ${eq.location}`});
  });

  const alertSection = document.getElementById('equip-alert-section');
  if(alerts.length===0){
    alertSection.innerHTML=`<div style="padding:12px 16px;background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);border-radius:10px;color:var(--green);font-size:13px">âœ… í˜„ì¬ ìƒíƒœ ì´ìƒ ì¥ë¹„ ì—†ìŒ â€” ëª¨ë“  ì¥ë¹„ ì •ìƒ ìš´ì˜ ì¤‘</div>`;
  } else {
    const colorMap={danger:'rgba(239,68,68,.1)',warn:'rgba(251,146,60,.1)',caution:'rgba(234,179,8,.1)'};
    const borderMap={danger:'rgba(239,68,68,.3)',warn:'rgba(251,146,60,.3)',caution:'rgba(234,179,8,.3)'};
    const textMap={danger:'var(--red)',warn:'var(--orange)',caution:'var(--yellow)'};
    alertSection.innerHTML=`
      <div style="display:flex;flex-direction:column;gap:8px;">
        ${alerts.map(a=>`
          <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:${colorMap[a.level]};border:1px solid ${borderMap[a.level]};border-radius:10px;">
            <span style="font-size:20px">${a.icon}</span>
            <div>
              <div style="font-size:13px;color:${textMap[a.level]}">${a.msg}</div>
              <div style="font-size:11px;color:var(--text3);margin-top:2px">${a.sub}</div>
            </div>
          </div>`).join('')}
      </div>`;
  }

  // â”€â”€ â‘¡ ìœ„ì¹˜ë³„ ì¥ë¹„ í˜„í™© â”€â”€
  const locationEl = document.getElementById('an-equip-location');
  if(!equipItems.length){ locationEl.innerHTML=`<div style="padding:24px;text-align:center;color:var(--text3)">ì¥ë¹„ ë°ì´í„° ì—†ìŒ</div>`; }
  else {
    // í—¤ë”
    let tbl = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead><tr style="background:var(--surface2);">
        <th style="padding:10px 14px;text-align:left;color:var(--text3);font-size:11px;min-width:110px">í’ˆëª©</th>
        ${LOCATIONS.map(l=>`<th style="padding:10px 10px;text-align:center;color:var(--text3);font-size:11px;min-width:70px">${l}</th>`).join('')}
        <th style="padding:10px 10px;text-align:center;color:var(--yellow);font-size:11px">ìˆ˜ë¦¬ì¤‘</th>
        <th style="padding:10px 10px;text-align:center;color:var(--red);font-size:11px">íê¸°</th>
        <th style="padding:10px 10px;text-align:center;color:var(--teal);font-size:11px">í•©ê³„</th>
        <th style="padding:10px 10px;text-align:center;color:var(--text3);font-size:11px">ê¸°ì¤€</th>
        <th style="padding:10px 14px;text-align:center;font-size:11px">ìƒíƒœ</th>
      </tr></thead><tbody>`;

    equipItems.forEach(item=>{
      const total = getEquipTotal(item);
      const active = getEquipActive(item);
      const pct = item.minStock>0 ? Math.round(active/item.minStock*100) : 100;
      const statusC = active>=item.minStock?'var(--green)':active>=item.minStock*0.7?'var(--yellow)':'var(--red)';
      const statusT = active>=item.minStock?'âœ“ ì •ìƒ':`âš  ${item.minStock-active}ëŒ€ ë¶€ì¡±`;
      tbl += `<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 14px;font-weight:700">${item.name}<div style="font-size:10px;color:var(--text3)">${item.unit||'ëŒ€'}</div></td>
        ${LOC_KEYS.map(k=>{
          const v=item[k]||0;
          return `<td style="padding:10px;text-align:center;font-family:'IBM Plex Mono',monospace;font-weight:${v>0?'700':'400'};color:${v>0?'var(--text)':'var(--text3)'}">
            ${v>0?v:'-'}
          </td>`;
        }).join('')}
        <td style="padding:10px;text-align:center;font-family:'IBM Plex Mono',monospace;color:${item.repair>0?'var(--yellow)':'var(--text3)'};font-weight:${item.repair>0?'700':'400'}">${item.repair>0?item.repair:'-'}</td>
        <td style="padding:10px;text-align:center;font-family:'IBM Plex Mono',monospace;color:${item.discard>0?'var(--red)':'var(--text3)'};font-weight:${item.discard>0?'700':'400'}">${item.discard>0?item.discard:'-'}</td>
        <td style="padding:10px;text-align:center;font-family:'IBM Plex Mono',monospace;font-weight:700;color:var(--teal)">${total}</td>
        <td style="padding:10px;text-align:center;color:var(--text3)">${item.minStock}</td>
        <td style="padding:10px 14px;text-align:center">
          <div style="font-size:12px;font-weight:700;color:${statusC}">${statusT}</div>
          <div style="margin-top:4px;height:4px;background:var(--surface2);border-radius:2px;width:80px;margin-left:auto;margin-right:auto">
            <div style="height:4px;background:${statusC};border-radius:2px;width:${Math.min(100,pct)}%"></div>
          </div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px">${pct}%</div>
        </td>
      </tr>`;
    });
    tbl += `</tbody></table>`;
    locationEl.innerHTML = tbl;
  }

  // â”€â”€ â‘¢ ë…¸í›„í™” í˜„í™© â”€â”€
  const agingEl = document.getElementById('an-equip-aging');
  const AGE_BANDS = [{label:'1ë…„ ë¯¸ë§Œ',min:0,max:12,color:'var(--green)'},{label:'1~3ë…„',min:12,max:36,color:'var(--teal)'},{label:'3~5ë…„',min:36,max:60,color:'var(--yellow)'},{label:'5~7ë…„',min:60,max:84,color:'var(--orange)'},{label:'7ë…„ ì´ìƒ',min:84,max:9999,color:'var(--red)'}];
  const activeEquips = equips.filter(e=>e.status!=='íê¸°'&&e.buyMonth);

  if(!activeEquips.length){ agingEl.innerHTML=`<div style="padding:24px;text-align:center;color:var(--text3)">êµ¬ë§¤ ê¸°ë¡ ì—†ìŒ</div>`; }
  else {
    const bands = AGE_BANDS.map(b=>{
      const list = activeEquips.filter(e=>{
        const mos = Math.floor((now - new Date(e.buyMonth+'-01'))/1000/60/60/24/30);
        return mos>=b.min && mos<b.max;
      });
      return {...b, list, count:list.length};
    });
    const maxCount = Math.max(...bands.map(b=>b.count),1);

    // ë§‰ëŒ€ ì°¨íŠ¸ + ìƒì„¸ ëª©ë¡
    let html = `<div style="padding:18px 20px 0">
      <div style="display:flex;align-items:flex-end;gap:12px;height:100px;margin-bottom:8px">
        ${bands.map(b=>{
          const h = Math.round(b.count/maxCount*80)+4;
          return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px">
            <span style="font-size:12px;font-weight:700;color:${b.color}">${b.count}</span>
            <div style="width:100%;height:${h}px;background:${b.color};border-radius:4px 4px 0 0;opacity:0.85"></div>
          </div>`;
        }).join('')}
      </div>
      <div style="display:flex;gap:12px;border-top:1px solid var(--border);padding-top:6px;margin-bottom:16px">
        ${bands.map(b=>`<div style="flex:1;text-align:center;font-size:10px;color:var(--text3)">${b.label}</div>`).join('')}
      </div>
    </div>`;

    // 5ë…„ ì´ìƒ ì¥ë¹„ ìƒì„¸ ëª©ë¡
    const oldEquips = activeEquips.filter(e=>{
      const mos = Math.floor((now - new Date(e.buyMonth+'-01'))/1000/60/60/24/30);
      return mos>=60;
    }).sort((a,b)=>a.buyMonth.localeCompare(b.buyMonth));

    if(oldEquips.length){
      html+=`<div style="padding:0 0 18px">
        <div style="padding:8px 20px;background:rgba(251,146,60,.08);border-top:1px solid var(--border);font-size:12px;font-weight:600;color:var(--orange)">â° êµì²´ ê²€í†  í•„ìš” ì¥ë¹„ (5ë…„ ì´ìƒ)</div>
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead><tr style="background:var(--surface2)">
            <th style="padding:8px 14px;text-align:left;color:var(--text3);font-size:11px">í’ˆëª©</th>
            <th style="padding:8px 10px;color:var(--text3);font-size:11px">ë²ˆí˜¸</th>
            <th style="padding:8px 10px;color:var(--text3);font-size:11px">êµ¬ë§¤ì›”</th>
            <th style="padding:8px 10px;color:var(--text3);font-size:11px">ê²½ê³¼</th>
            <th style="padding:8px 10px;color:var(--text3);font-size:11px">ìœ„ì¹˜</th>
            <th style="padding:8px 10px;color:var(--text3);font-size:11px">ìƒíƒœ</th>
          </tr></thead><tbody>
          ${oldEquips.map(e=>{
            const mos = Math.floor((now - new Date(e.buyMonth+'-01'))/1000/60/60/24/30);
            const yrs = (mos/12).toFixed(1);
            const c = mos>=84?'var(--red)':'var(--orange)';
            return `<tr style="border-bottom:1px solid var(--border)">
              <td style="padding:9px 14px;font-weight:600">${e.itemName}</td>
              <td style="padding:9px 10px;color:var(--text3)">#${e.num||'?'}</td>
              <td style="padding:9px 10px;font-family:'IBM Plex Mono',monospace">${e.buyMonth}</td>
              <td style="padding:9px 10px;font-weight:700;color:${c};font-family:'IBM Plex Mono',monospace">${yrs}ë…„</td>
              <td style="padding:9px 10px;color:var(--text3)">${e.location}</td>
              <td style="padding:9px 10px">
                <span style="font-size:11px;font-weight:600;color:${e.status==='ìˆ˜ë¦¬ì¤‘'?'var(--yellow)':e.status==='ì‚¬ìš©ì¤‘'?'var(--green)':'var(--text3)'}">${e.status}</span>
              </td>
            </tr>`;
          }).join('')}
          </tbody>
        </table>
      </div>`;
    } else {
      html += `<div style="padding:12px 20px 18px;font-size:12px;color:var(--green)">âœ… 5ë…„ ì´ìƒ ë…¸í›„ ì¥ë¹„ ì—†ìŒ</div>`;
    }
    agingEl.innerHTML = html;
  }

  // â”€â”€ â‘£ ìˆ˜ë¦¬Â·íê¸° í˜„í™© & êµì²´ ì˜ˆì¸¡ â”€â”€
  const replaceEl = document.getElementById('an-equip-replace');
  let replaceHtml = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
    <thead><tr style="background:var(--surface2)">
      <th style="padding:10px 14px;text-align:left;color:var(--text3);font-size:11px;min-width:120px">í’ˆëª©</th>
      <th style="padding:10px 10px;text-align:center;color:var(--teal);font-size:11px">ì „ì²´</th>
      <th style="padding:10px 10px;text-align:center;color:var(--green);font-size:11px">ì‚¬ìš©ì¤‘</th>
      <th style="padding:10px 10px;text-align:center;color:var(--yellow);font-size:11px">ìˆ˜ë¦¬ì¤‘</th>
      <th style="padding:10px 10px;text-align:center;color:var(--red);font-size:11px">íê¸°</th>
      <th style="padding:10px 10px;text-align:center;color:var(--text3);font-size:11px">ìˆ˜ë¦¬ìœ¨</th>
      <th style="padding:10px 10px;text-align:center;color:var(--text3);font-size:11px">íê¸°ìœ¨</th>
      <th style="padding:10px 14px;text-align:center;color:var(--orange);font-size:11px">ì—°ê°„ êµì²´ ì˜ˆì¸¡</th>
    </tr></thead><tbody>`;

  equipItems.forEach(item=>{
    const all    = equips.filter(e=>e.itemName===item.name);
    const total  = all.length;
    const active = all.filter(e=>e.status==='ì‚¬ìš©ì¤‘'||e.status==='ì—¬ë¶„').length;
    const repair = all.filter(e=>e.status==='ìˆ˜ë¦¬ì¤‘').length;
    const discard= all.filter(e=>e.status==='íê¸°').length;
    const repairRate  = total>0 ? (repair/total*100).toFixed(0) : 0;
    const discardRate = total>0 ? (discard/total*100).toFixed(0) : 0;

    // êµì²´ ì˜ˆì¸¡: íê¸°ëœ ì¥ë¹„ë“¤ì˜ í‰ê·  ìˆ˜ëª… ê³„ì‚°
    const discardedWithAge = all.filter(e=>e.status==='íê¸°'&&e.buyMonth&&e.discardMonth).map(e=>{
      return Math.floor((new Date(e.discardMonth+'-01') - new Date(e.buyMonth+'-01'))/1000/60/60/24/30);
    });
    const avgLifeMos = discardedWithAge.length > 0
      ? Math.round(discardedWithAge.reduce((a,b)=>a+b,0)/discardedWithAge.length)
      : null;

    // í–¥í›„ 12ê°œì›” ë‚´ êµì²´ ê¶Œì¥ (êµ¬ë§¤ í›„ avgLifeMos ì´ìƒ ëœ ì‚¬ìš©ì¤‘ ì¥ë¹„)
    let replaceSoon = 0;
    if(avgLifeMos){
      replaceSoon = all.filter(e=>{
        if(e.status==='íê¸°'||!e.buyMonth) return false;
        const mos = Math.floor((now - new Date(e.buyMonth+'-01'))/1000/60/60/24/30);
        return mos >= avgLifeMos * 0.9; // ìˆ˜ëª… 90% ë„ë‹¬
      }).length;
    }

    const rc = parseInt(repairRate)>=20?'var(--red)':parseInt(repairRate)>=10?'var(--yellow)':'var(--text3)';
    const dc = parseInt(discardRate)>=30?'var(--red)':parseInt(discardRate)>=15?'var(--orange)':'var(--text3)';

    replaceHtml += `<tr style="border-bottom:1px solid var(--border)">
      <td style="padding:10px 14px;font-weight:700">${item.name}</td>
      <td style="padding:10px;text-align:center;font-family:'IBM Plex Mono',monospace;font-weight:700;color:var(--teal)">${total}</td>
      <td style="padding:10px;text-align:center;font-family:'IBM Plex Mono',monospace;color:var(--green)">${active}</td>
      <td style="padding:10px;text-align:center;font-family:'IBM Plex Mono',monospace;color:${repair>0?'var(--yellow)':'var(--text3)'};font-weight:${repair>0?700:400}">${repair||'-'}</td>
      <td style="padding:10px;text-align:center;font-family:'IBM Plex Mono',monospace;color:${discard>0?'var(--red)':'var(--text3)'};font-weight:${discard>0?700:400}">${discard||'-'}</td>
      <td style="padding:10px;text-align:center;font-weight:700;color:${rc}">${repairRate}%</td>
      <td style="padding:10px;text-align:center;font-weight:700;color:${dc}">${discardRate}%</td>
      <td style="padding:10px 14px;text-align:center">
        ${avgLifeMos
          ? `<div style="font-size:13px;font-weight:700;color:${replaceSoon>0?'var(--orange)':'var(--green)'}">
              ${replaceSoon>0?`+${replaceSoon}ëŒ€ êµì²´ ê¶Œì¥`:'êµì²´ ë¶ˆí•„ìš”'}
             </div>
             <div style="font-size:10px;color:var(--text3);margin-top:2px">í‰ê·  ìˆ˜ëª… ${(avgLifeMos/12).toFixed(1)}ë…„ ê¸°ì¤€</div>`
          : `<div style="font-size:11px;color:var(--text3)">íê¸° ì´ë ¥ ì—†ìŒ<br>ì˜ˆì¸¡ ë¶ˆê°€</div>`}
      </td>
    </tr>`;
  });
  replaceHtml += `</tbody></table>`;
  replaceEl.innerHTML = replaceHtml;
}

function autoCalcPerHead(itemId){
  // ìë™ ê³„ì‚°: ì‹¤ì¸¡ í‰ê·  ì ìš©
  const year = parseInt(document.getElementById('an-year')?.value || new Date().getFullYear());
  const item = items.find(i=>i.id===itemId); if(!item) return;
  const totalOut = Array.from({length:12},(_,m)=>getMonthlyOut(item.id,getMonthKey(year,m+1))).reduce((a,b)=>a+b,0);
  const totalVis = Object.entries(visitors).filter(([k])=>k.startsWith(year)).reduce((s,[,v])=>s+v,0);
  if(!totalVis||!totalOut){toast('ì…ì¥ê° ë˜ëŠ” ì¶œê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤','âš ï¸');return;}
  perHead[itemId] = totalOut/totalVis;
  saveData(); renderAnalytics();
  toast(`${item.name} 1ì¸ë‹¹ ì†Œëª¨ëŸ‰ ì—…ë°ì´íŠ¸: ${(perHead[itemId]).toFixed(4)}`,'âœ…');
}

// â”€â”€ Visitor Modal â”€â”€
function openVisitorModal(){
  const year = parseInt(document.getElementById('an-year')?.value || new Date().getFullYear());
  document.getElementById('vm-year').value = year;
  buildVisitorGrid(year);
  openM('visitor-modal');
}
function buildVisitorGrid(year){
  document.getElementById('vm-months-grid').innerHTML = MONTHS.map((mn,m)=>{
    const key=getMonthKey(year,m+1);
    const val=visitors[key]||'';
    return `<div class="fg" style="margin-bottom:10px">
      <label class="fl">${mn}</label>
      <input class="fi" type="number" id="vm-m-${m+1}" value="${val}" placeholder="0" min="0" style="font-family:'IBM Plex Mono',monospace">
    </div>`;
  }).join('');
}
function saveVisitors(){
  const year = parseInt(document.getElementById('vm-year').value);
  MONTHS.forEach((_,m)=>{
    const val=parseInt(document.getElementById(`vm-m-${m+1}`)?.value)||0;
    const key=getMonthKey(year,m+1);
    if(val>0) visitors[key]=val;
    else delete visitors[key];
  });
  saveData(); closeM('visitor-modal'); renderAnalytics();
  toast('ì…ì¥ê° ë°ì´í„° ì €ì¥ë¨','âœ…');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXCEL ê°€ì ¸ì˜¤ê¸° / ë‚´ë³´ë‚´ê¸°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function importXlsx(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      // cellDates ì œê±° â†’ ë‚ ì§œë¥¼ Date ê°ì²´ ì•„ë‹Œ ë¬¸ìì—´ë¡œ ë°›ìŒ (UTC ë³€í™˜ ë¬¸ì œ ì›ì²œ ì°¨ë‹¨)
      const wb=XLSX.read(e.target.result,{type:'array', cellDates:false, cellText:false});
      let imported={cons:0, visitors:0, equips:0, autoAdded:[], errors:[]};

      // â”€â”€ ë‚ ì§œ ì •ê·œí™”: ì—‘ì…€ ì‹œë¦¬ì–¼ ìˆ«ì â†’ YYYY-MM-DD â”€â”€
      // raw:false + cellDates:false ì‹œ ë‚ ì§œ ì…€ì€ ì—‘ì…€ ì‹œë¦¬ì–¼ ìˆ«ìë¡œ ì˜´
      const toDateStr=v=>{
        if(!v&&v!==0) return '';
        // ì—‘ì…€ ì‹œë¦¬ì–¼ ìˆ«ì (ì˜ˆ: 45658)
        if(typeof v==='number'||(!isNaN(Number(v))&&String(v).trim()!==''&&!/[-\/T]/.test(String(v)))){
          const n=typeof v==='number'?v:Number(v);
          if(n>40000&&n<60000){
            // ì—‘ì…€ ì‹œë¦¬ì–¼ â†’ UTC ë‚ ì§œ (ì—‘ì…€ì€ UTC ê¸°ì¤€ ì €ì¥)
            const d=new Date(Math.round((n-25569)*86400*1000));
            return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
          }
        }
        const s=String(v).trim();
        if(!s) return '';
        // YYYY-MM-DD ì´ë¯¸ ì •ìƒ
        if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        // ISO ë¬¸ìì—´
        if(/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.substring(0,10);
        // M/D/YYYY
        const mdy=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if(mdy) return `${mdy[3]}-${mdy[1].padStart(2,'0')}-${mdy[2].padStart(2,'0')}`;
        // YYYY/MM/DD
        const ymd=s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
        if(ymd) return `${ymd[1]}-${ymd[2].padStart(2,'0')}-${ymd[3].padStart(2,'0')}`;
        // YYYY-M-D (íŒ¨ë”© ì—†ëŠ” ê²½ìš°)
        const ymd2=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if(ymd2) return `${ymd2[1]}-${ymd2[2].padStart(2,'0')}-${ymd2[3].padStart(2,'0')}`;
        return s;
      };
      const toMonthStr=v=>{
        const d=toDateStr(v);
        return d.length>=7?d.substring(0,7):'';
      };
      const str=v=>v==null?'':String(v).trim();

      const normalizeLocation=raw=>{
        const s=str(raw).replace(/\s+/g,'');
        const m={
          'ì—¬ì‚¬B1':'ì—¬ì‚¬ B1','ì—¬ì‚¬B2':'ì—¬ì‚¬ B2',
          'ë‚¨ì‚¬B1':'ë‚¨ì‚¬ B1','ë‚¨ì‚¬B2':'ë‚¨ì‚¬ B2',
          'ì§€ì›íŒ€':'ì§€ì›íŒ€','ì§ì›ìš©':'ì§ì›ìš©','ì—¬ë¶„':'ì—¬ë¶„',
          'ìˆ˜ë¦¬ì˜ˆì •':'ì—¬ë¶„','íê¸°ì˜ˆì •':'ì—¬ë¶„',
        };
        return m[s]||'ì—¬ë¶„';
      };
      const normalizeStatus=raw=>{
        const s=str(raw);
        const m={'ì‚¬ìš©ì¤‘':'ì‚¬ìš©ì¤‘','ì‚¬ìš©':'ì‚¬ìš©ì¤‘',
                 'ìˆ˜ë¦¬ì¤‘':'ìˆ˜ë¦¬ì¤‘','ìˆ˜ë¦¬':'ìˆ˜ë¦¬ì¤‘','ìˆ˜ë¦¬ì˜ˆì •':'ìˆ˜ë¦¬ì¤‘',
                 'ì—¬ë¶„':'ì—¬ë¶„','ë³´ê´€':'ì—¬ë¶„',
                 'íê¸°':'íê¸°','íê¸°ì˜ˆì •':'íê¸°'};
        return m[s]||'ì‚¬ìš©ì¤‘';
      };

      // â”€â”€ ì‹œíŠ¸ íŒŒì‹± í—¬í¼ (3í–‰ í—¤ë” ê¸°ì¤€) â”€â”€
      const getSheetRows=(ws, headerRow=3)=>{
        // raw:false â†’ ìˆ«ìÂ·ë‚ ì§œ ëª¨ë‘ ë¬¸ìì—´í™”, cellDates ì—†ìŒ
        const raw=XLSX.utils.sheet_to_json(ws,{header:1, defval:null, raw:true});
        const hdrArr=raw[headerRow-1]||[];
        const cleanH=h=>h==null?'':String(h).replace(/\n/g,'').replace(/\s+/g,' ').trim();
        const headers=hdrArr.map(cleanH);
        return raw.slice(headerRow).map(rowArr=>{
          const obj={};
          headers.forEach((h,i)=>{ if(h) obj[h]=rowArr[i]??null; });
          return obj;
        });
      };

      // â•â• 1. ì†Œëª¨í’ˆ_êµ¬ë§¤ì†Œëª¨ ì‹œíŠ¸ â•â•
      const wsName=wb.SheetNames.find(n=>n.includes('ì†Œëª¨í’ˆ')||n.includes('êµ¬ë§¤'));
      if(wsName){
        const rows=getSheetRows(wb.Sheets[wsName], 3);
        rows.forEach((row,idx)=>{
          const dateRaw = row['ë‚ ì§œ']||'';
          const itemName= str(row['í’ˆëª©ëª…']||row['í’ˆëª©']||'');
          const typeRaw = str(row['ìœ í˜•(êµ¬ë§¤/ì†Œëª¨)']||row['ìœ í˜•']||'');
          const qty     = parseInt(row['ìˆ˜ëŸ‰']||0)||0;
          const unit    = str(row['ë‹¨ìœ„']||'ê°œ');
          const note    = str(row['ë©”ëª¨(ë‚©í’ˆì²˜Â·ì†Œëª¨ìœ„ì¹˜ ë“±)']||row['ë©”ëª¨']||'');

          if(!dateRaw||!itemName||!typeRaw||!qty) return;
          if(itemName==='í’ˆëª©ëª…'||itemName.startsWith('âš ')||itemName.startsWith('[')) return;

          const dateStr=toDateStr(dateRaw);

          if(!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)){
            imported.errors.push(`ì†Œëª¨í’ˆ ${idx+4}í–‰: ë‚ ì§œ ì˜¤ë¥˜ (${dateRaw}â†’${dateStr})`); return;
          }
          const type=(typeRaw==='êµ¬ë§¤'||typeRaw==='in')?'in':(typeRaw==='ì†Œëª¨'||typeRaw==='out')?'out':null;
          if(!type){imported.errors.push(`ì†Œëª¨í’ˆ ${idx+4}í–‰: ìœ í˜• ì˜¤ë¥˜ "${typeRaw}"`);return;}

          let item=items.find(i=>i.name===itemName&&i.type==='consumable');
          if(!item){
            item={id:nextItemId++,type:'consumable',name:itemName,
                  category:'ì†Œëª¨í’ˆ',minStock:10,monthlyUsage:0,
                  unit:unit||'ê°œ',stock:0,note:''};
            items.push(item);
            if(!imported.autoAdded.includes(itemName)) imported.autoAdded.push(itemName);
          }
          if(consLogs.find(l=>l.date===dateStr&&l.itemId===item.id&&l.type===type&&l.qty===qty)) return;

          const before=item.stock||0;
          item.stock=type==='in'?before+qty:Math.max(0,before-qty);
          consLogs.push({
            id:'cl'+Date.now()+Math.random(),
            itemId:item.id,itemName:item.name,
            unit:unit||item.unit||'ê°œ',type,qty,
            stockBefore:before,stockAfter:item.stock,
            date:dateStr,note
          });
          imported.cons++;
        });
        consLogs.sort((a,b)=>(a.date||'').localeCompare(b.date||''));
      }

      // â•â• 2. ì…ì¥ê° ì‹œíŠ¸ â•â•
      const vsName=wb.SheetNames.find(n=>n.includes('ì…ì¥ê°')||n.includes('visitor'));
      if(vsName){
        const rows=getSheetRows(wb.Sheets[vsName], 3);
        rows.forEach(row=>{
          const yr =parseInt(row['ì—°ë„']||row['year']||0);
          const mo =parseInt(row['ì›”']||row['month']||0);
          const cnt=parseInt(row['ì…ì¥ê° ìˆ˜']||row['ì…ì¥ê°ìˆ˜']||row['visitors']||0);
          if(!yr||!mo||!cnt||yr<2020||yr>2030||mo<1||mo>12) return;
          visitors[`${yr}-${String(mo).padStart(2,'0')}`]=cnt;
          imported.visitors++;
        });
      }

      // â•â• 3. ì¥ë¹„ì´ë ¥ â€” 'ì¥ë¹„' í¬í•¨ ì‹œíŠ¸ ì „ë¶€ ì²˜ë¦¬ â•â•
      const eqSheets=wb.SheetNames.filter(n=>n.includes('ì¥ë¹„'));
      eqSheets.forEach(eqName=>{
        const rows=getSheetRows(wb.Sheets[eqName], 3);
        rows.forEach((row,idx)=>{
          const itemName=str(row['í’ˆëª©ëª…']||'');
          const num     =str(row['ë²ˆí˜¸']||'');
          const model   =str(row['ì œì¡°ì‚¬/ëª¨ë¸']||row['ëª¨ë¸']||'');
          const rawSt   =str(row['ìƒíƒœ']||'ì‚¬ìš©ì¤‘');
          const rawLoc  =str(row['ì„¤ì¹˜ìœ„ì¹˜']||row['ìœ„ì¹˜']||'ì—¬ë¶„');
          // í—¤ë” í–‰Â·ì•ˆë‚´ í–‰ ìŠ¤í‚µ
          if(!itemName||itemName==='í’ˆëª©ëª…'||itemName.startsWith('âš ')) return;

          // ì¥ë¹„ í’ˆëª© í™•ì¸ â€” ì—†ìœ¼ë©´ ìë™ ìƒì„±
          let item=items.find(i=>i.name===itemName&&i.type==='equip');
          if(!item){
            item={id:nextItemId++,type:'equip',name:itemName,
                  category:'ì „ê¸°ìš©í’ˆ',minStock:1,monthlyUsage:0,unit:'ëŒ€',stock:0,note:'',
                  fb1:0,fb2:0,mb1:0,mb2:0,sup:0,emp:0,spare:0,repair:0,discard:0};
            items.push(item);
            const tag=itemName+' (ì¥ë¹„)';
            if(!imported.autoAdded.includes(tag)) imported.autoAdded.push(tag);
          }
          // ì¤‘ë³µ ìŠ¤í‚µ
          if(num&&equips.find(eq=>eq.itemName===itemName&&eq.num===num)) return;

          // êµ¬ë§¤ì›”Â·íê¸°ì›” í—¤ë”ì— \n í¬í•¨ â†’ cleanHeader í›„ 'êµ¬ë§¤ì›”(YYYY-MM)'
          const buyRaw =row['êµ¬ë§¤ì›”(YYYY-MM)']||row['êµ¬ë§¤ì›”']||'';
          const instRaw=row['ì„¤ì¹˜ì¼(YYYY-MM-DD)']||row['ì„¤ì¹˜ì¼']||'';
          const discRaw=row['íê¸°ì›”(YYYY-MM)']||row['íê¸°ì›”']||'';

          equips.push({
            id:'e'+Date.now()+Math.random(),
            itemName,num,model,
            buyMonth:    toMonthStr(buyRaw),
            installDate: toDateStr(instRaw),
            location:    normalizeLocation(rawLoc),
            status:      normalizeStatus(rawSt),
            discardMonth:toMonthStr(discRaw),
            discardReason:str(row['íê¸°ì‚¬ìœ ']||''),
            note:         str(row['ë©”ëª¨']||'')
          });
          imported.equips++;
        });
      });
      if(eqSheets.length>0) syncEquipToItems();

      saveData();
      renderDashboard();renderItems();renderManage();
      if(document.getElementById('page-equipment').classList.contains('active')) renderEquip();
      if(document.getElementById('page-consumable').classList.contains('active')) renderCons();
      if(document.getElementById('page-analytics').classList.contains('active')) renderAnalytics();
      // ë°ì´í„° ë¶„ì„ ì—°ë„ ì…€ë ‰í„° ì—…ë°ì´íŠ¸ â€” ê°€ì ¸ì˜¨ ë°ì´í„° ì—°ë„ ìë™ ë°˜ì˜
      const importedYears=[...new Set(Object.keys(visitors).map(k=>k.split('-')[0]))];
      const anYearSel=document.getElementById('an-year');
      if(anYearSel&&importedYears.length){
        const existing=[...anYearSel.options].map(o=>o.value);
        importedYears.forEach(y=>{
          if(!existing.includes(y)){
            const opt=document.createElement('option');
            opt.value=y;opt.textContent=y+'ë…„';
            anYearSel.insertBefore(opt,anYearSel.firstChild);
          }
        });
        // ê°€ì¥ ë§ì€ ë°ì´í„°ê°€ ìˆëŠ” ì—°ë„ë¡œ ìë™ ì„ íƒ
        anYearSel.value=importedYears.sort()[0];
      }
      const consYearSel=document.getElementById('cons-year-sel');
      if(consYearSel&&importedYears.length){
        const existing=[...consYearSel.options].map(o=>o.value);
        importedYears.forEach(y=>{
          if(!existing.includes(y)){
            const opt=document.createElement('option');
            opt.value=y;opt.textContent=y+'ë…„';
            consYearSel.insertBefore(opt,consYearSel.firstChild);
          }
        });
        consYearSel.value=importedYears.sort()[0];
      }

      // â”€â”€ ê²°ê³¼ íŒì—… â”€â”€
      let msg=`âœ… ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!\n\n`
        +`â€¢ êµ¬ë§¤Â·ì†Œëª¨ ì´ë ¥ : ${imported.cons}ê±´\n`
        +`â€¢ ì…ì¥ê° ë°ì´í„°  : ${imported.visitors}ê±´\n`
        +`â€¢ ì¥ë¹„ ì´ë ¥      : ${imported.equips}ê±´ (${eqSheets.length}ê°œ ì‹œíŠ¸)`;
      if(imported.autoAdded.length){
        msg+=`\n\nğŸ“Œ ìë™ ìƒì„± í’ˆëª© (${imported.autoAdded.length}ê°œ):\n${imported.autoAdded.join(', ')}\nâ†’ [í’ˆëª© ê´€ë¦¬]ì—ì„œ ê¸°ì¤€ì¬ê³ Â·ì›”ì†Œëª¨ëŸ‰ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.`;
      }
      if(imported.errors.length){
        msg+=`\n\nâš  ê±´ë„ˆë›´ í•­ëª© ${imported.errors.length}ê±´:\n`+imported.errors.slice(0,6).join('\n');
        if(imported.errors.length>6) msg+=`\n... ì™¸ ${imported.errors.length-6}ê±´`;
      }
      alert(msg);
    }catch(err){
      alert('âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: '+err.message);
      console.error(err);
    }
    input.value='';
  };
  reader.readAsArrayBuffer(file);
  toast('íŒŒì¼ ë¶„ì„ ì¤‘...','ğŸ“‚');
}

// â”€â”€ í˜„ì¬ ë°ì´í„° ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸° â”€â”€
function exportCurrentData(){
  const wb=XLSX.utils.book_new();

  // ì†Œëª¨í’ˆ ì´ë ¥
  const consRows=consLogs.map(l=>({
    ë‚ ì§œ:l.date||'',
    í’ˆëª©ëª…:l.itemName,
    ìœ í˜•:l.type==='in'?'êµ¬ë§¤':'ì†Œëª¨',
    ìˆ˜ëŸ‰:l.qty,
    ë‹¨ìœ„:l.unit||'ê°œ',
    ì²˜ë¦¬í›„ì¬ê³ :l.stockAfter,
    ë©”ëª¨:l.note||''
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(consRows), 'ì†Œëª¨í’ˆ_êµ¬ë§¤ì†Œëª¨');

  // ì…ì¥ê°
  const visRows=Object.entries(visitors).sort().map(([k,v])=>({
    ì—°ë„:parseInt(k.split('-')[0]),
    ì›”:parseInt(k.split('-')[1]),
    'ì…ì¥ê° ìˆ˜':v
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(visRows), 'ì…ì¥ê°');

  // ì¥ë¹„ì´ë ¥
  const eqRows=equips.map(e=>({
    í’ˆëª©ëª…:e.itemName, ë²ˆí˜¸:e.num, 'ì œì¡°ì‚¬/ëª¨ë¸':e.model,
    êµ¬ë§¤ì›”:e.buyMonth, ì„¤ì¹˜ì¼:e.installDate, ì„¤ì¹˜ìœ„ì¹˜:e.location,
    ìƒíƒœ:e.status, íê¸°ì›”:e.discardMonth, íê¸°ì‚¬ìœ :e.discardReason, ë©”ëª¨:e.note
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(eqRows), 'ì¥ë¹„ì´ë ¥');

  const today=nowDate();
  XLSX.writeFile(wb, `ì‚¬ìš°ë‚˜_ë¹„í’ˆë°ì´í„°_${today}.xlsx`);
  toast('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ','ğŸ’¾');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BULK MANUAL ENTRY (ì›”ë³„ í’ˆëª© ìˆ˜ê¸°ì…ë ¥)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openBulkEntry(){
  // ì—°ë„/ì›” ì…€ë ‰í„° ì´ˆê¸°ê°’: í˜„ì¬ ì›”
  const now=new Date();
  document.getElementById('bulk-year').value=now.getFullYear();
  document.getElementById('bulk-month').value=String(now.getMonth()+1).padStart(2,'0');
  buildBulkGrid();
  document.getElementById('bulk-status').textContent='';
  openM('bulk-modal');
}

function buildBulkGrid(){
  const year=document.getElementById('bulk-year').value;
  const month=document.getElementById('bulk-month').value;
  const consItems=items.filter(i=>i.type==='consumable');
  const tbody=document.getElementById('bulk-tbody');

  if(!consItems.length){
    tbody.innerHTML=`<tr><td colspan="4" style="padding:24px;text-align:center;color:var(--text3)">ë“±ë¡ëœ ì†Œëª¨í’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>í’ˆëª© ê´€ë¦¬ì—ì„œ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.</td></tr>`;
    return;
  }

  // í•´ë‹¹ ì›”ì— ì´ë¯¸ ê¸°ë¡ëœ ê°’ ì¡°íšŒ
  const monthKey=`${year}-${month}`;
  const getExisting=(itemId,type)=>{
    const logs=consLogs.filter(l=>l.itemId===itemId&&l.type===type&&(l.date||'').startsWith(monthKey));
    return logs.reduce((s,l)=>s+l.qty,0)||'';
  };

  tbody.innerHTML=consItems.map((item,i)=>`
    <tr style="border-bottom:1px solid var(--border);" id="bulk-row-${i}">
      <td style="padding:10px 12px;font-weight:600;color:var(--text);font-size:13px;min-width:130px">
        ${item.name}
        <div style="font-size:11px;color:var(--text3);margin-top:2px">${item.unit||'ê°œ'} Â· í˜„ì¬ì¬ê³  ${item.stock||0}</div>
      </td>
      <td style="padding:8px 10px;min-width:130px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:11px;color:var(--green);font-weight:600;min-width:28px">ğŸ›’êµ¬ë§¤</span>
          <input type="number" min="0" placeholder="0" id="bi-in-${i}"
            value="${getExisting(item.id,'in')}"
            style="width:90px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;color:var(--text);font-family:'IBM Plex Mono',monospace;outline:none;"
            onfocus="this.style.borderColor='var(--green)'" onblur="this.style.borderColor='var(--border)'">
        </div>
      </td>
      <td style="padding:8px 10px;min-width:130px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:11px;color:var(--orange);font-weight:600;min-width:28px">ğŸ“¦ì†Œëª¨</span>
          <input type="number" min="0" placeholder="0" id="bi-out-${i}"
            value="${getExisting(item.id,'out')}"
            style="width:90px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;color:var(--text);font-family:'IBM Plex Mono',monospace;outline:none;"
            onfocus="this.style.borderColor='var(--orange)'" onblur="this.style.borderColor='var(--border)'">
        </div>
      </td>
      <td style="padding:8px 10px">
        <input type="text" placeholder="ë©”ëª¨ (ë‚©í’ˆì²˜ ë“±)" id="bi-note-${i}"
          style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:12px;color:var(--text);outline:none;"
          onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
      </td>
    </tr>
  `).join('');

  // ì…ë ¥ í–‰ ìˆ˜ í‘œì‹œ
  document.getElementById('bulk-status').textContent=`${consItems.length}ê°œ í’ˆëª© Â· ${year}ë…„ ${parseInt(month)}ì›”`;
  document.getElementById('bulk-status').style.color='var(--text3)';
}

function saveBulkEntry(){
  const year=document.getElementById('bulk-year').value;
  const month=document.getElementById('bulk-month').value;
  const day=document.getElementById('bulk-day').value||'01';
  const date=`${year}-${month}-${day.padStart(2,'0')}`;
  const consItems=items.filter(i=>i.type==='consumable');
  let saved=0;

  consItems.forEach((item,i)=>{
    const inQty =parseInt(document.getElementById('bi-in-'+i)?.value||0)||0;
    const outQty=parseInt(document.getElementById('bi-out-'+i)?.value||0)||0;
    const note  =document.getElementById('bi-note-'+i)?.value||'';
    const monthKey=`${year}-${month}`;

    // êµ¬ë§¤
    if(inQty>0){
      // ê°™ì€ ì›” ê°™ì€ ìˆ˜ëŸ‰ ì¤‘ë³µì´ë©´ ìŠ¤í‚µ
      const dup=consLogs.find(l=>l.itemId===item.id&&l.type==='in'&&(l.date||'').startsWith(monthKey)&&l.qty===inQty);
      if(!dup){
        const before=item.stock||0;
        item.stock=before+inQty;
        consLogs.push({id:'cl'+Date.now()+Math.random(),itemId:item.id,itemName:item.name,
          unit:item.unit||'ê°œ',type:'in',qty:inQty,stockBefore:before,stockAfter:item.stock,date,note});
        saved++;
      }
    }
    // ì†Œëª¨
    if(outQty>0){
      const dup=consLogs.find(l=>l.itemId===item.id&&l.type==='out'&&(l.date||'').startsWith(monthKey)&&l.qty===outQty);
      if(!dup){
        const before=item.stock||0;
        item.stock=Math.max(0,before-outQty);
        consLogs.push({id:'cl'+Date.now()+Math.random(),itemId:item.id,itemName:item.name,
          unit:item.unit||'ê°œ',type:'out',qty:outQty,stockBefore:before,stockAfter:item.stock,date,note});
        saved++;
      }
    }
  });

  if(saved>0){
    consLogs.sort((a,b)=>(a.date||'').localeCompare(b.date||''));
    saveData();
    renderCons();renderDashboard();
    if(document.getElementById('page-analytics').classList.contains('active')) renderAnalytics();
    // ì—°ë„ ì…€ë ‰í„°ì— í•´ë‹¹ ì—°ë„ ì¶”ê°€
    const anYearSel=document.getElementById('an-year');
    if(anYearSel&&![...anYearSel.options].find(o=>o.value===year)){
      const opt=document.createElement('option');opt.value=year;opt.textContent=year+'ë…„';
      anYearSel.insertBefore(opt,anYearSel.firstChild);
    }
    const consYearSel=document.getElementById('cons-year-sel');
    if(consYearSel&&![...consYearSel.options].find(o=>o.value===year)){
      const opt=document.createElement('option');opt.value=year;opt.textContent=year+'ë…„';
      consYearSel.insertBefore(opt,consYearSel.firstChild);
    }
    closeM('bulk-modal');
    toast(`${saved}ê±´ ì €ì¥ ì™„ë£Œ (${year}ë…„ ${parseInt(month)}ì›”)`,'âœ…');
  } else {
    document.getElementById('bulk-status').textContent='âš ï¸ ì…ë ¥ëœ ìˆ˜ëŸ‰ì´ ì—†ê±°ë‚˜ ì´ë¯¸ ë™ì¼í•œ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.';
    document.getElementById('bulk-status').style.color='var(--orange)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openM(id){document.getElementById(id).classList.add('open');}
function closeM(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.moverlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));
function toast(msg,icon='â„¹ï¸'){
  const t=document.createElement('div');t.className='toast';t.innerHTML=`<span>${icon}</span> ${msg}`;
  document.getElementById('toasts').appendChild(t);setTimeout(()=>t.remove(),2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ì•± ì‹œì‘ â”€â”€
(async()=>{
  await loadData();
  startRealtimeSync();
  renderDashboard();
})();
</script>
<!-- â•â•â• ì¼ê´„ ìˆ˜ê¸°ì…ë ¥ MODAL â•â•â• -->
<div class="moverlay" id="bulk-modal">
  <div class="modal" style="max-width:680px;width:96vw">
    <div class="mhead">
      <div class="mtitle">ğŸ“‹ êµ¬ë§¤Â·ì†Œëª¨ ì›”ë³„ ìˆ˜ê¸°ì…ë ¥</div>
      <button class="xbtn" onclick="closeM('bulk-modal')">âœ•</button>
    </div>
    <div class="mbody" style="padding:0">
      <!-- ì—°ë„/ì›” ì„ íƒ -->
      <div style="padding:14px 18px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <span style="font-size:13px;color:var(--text2);font-weight:600">ğŸ“… ì…ë ¥ ê¸°ì¤€ ì›”</span>
        <select id="bulk-year" onchange="buildBulkGrid()"
          style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;color:var(--text)">
          <option value="2023">2023ë…„</option>
          <option value="2024">2024ë…„</option>
          <option value="2025">2025ë…„</option>
          <option value="2026" selected>2026ë…„</option>
        </select>
        <select id="bulk-month" onchange="buildBulkGrid()"
          style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;color:var(--text)">
          <option value="01">1ì›”</option><option value="02">2ì›”</option><option value="03">3ì›”</option>
          <option value="04">4ì›”</option><option value="05">5ì›”</option><option value="06">6ì›”</option>
          <option value="07">7ì›”</option><option value="08">8ì›”</option><option value="09">9ì›”</option>
          <option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option>
        </select>
        <div style="display:flex;align-items:center;gap:6px;margin-left:8px">
          <span style="font-size:12px;color:var(--text3)">ê¸°ì¤€ì¼</span>
          <input type="number" id="bulk-day" value="01" min="1" max="31" placeholder="01"
            style="width:54px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:13px;color:var(--text);text-align:center">
          <span style="font-size:12px;color:var(--text3)">ì¼</span>
        </div>
      </div>
      <!-- í’ˆëª© ê·¸ë¦¬ë“œ -->
      <div style="overflow-y:auto;max-height:440px;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:var(--surface2);position:sticky;top:0;z-index:1;border-bottom:2px solid var(--border)">
              <th style="padding:10px 14px;text-align:left;color:var(--text3);font-size:11px;min-width:140px">í’ˆëª©</th>
              <th style="padding:10px 14px;text-align:center;color:var(--green);font-size:12px;font-weight:700;min-width:140px">ğŸ›’ êµ¬ë§¤ ìˆ˜ëŸ‰</th>
              <th style="padding:10px 14px;text-align:center;color:var(--orange);font-size:12px;font-weight:700;min-width:140px">ğŸ“¦ ì†Œëª¨ ìˆ˜ëŸ‰</th>
              <th style="padding:10px 14px;text-align:left;color:var(--text3);font-size:11px">ë©”ëª¨</th>
            </tr>
          </thead>
          <tbody id="bulk-tbody"></tbody>
        </table>
      </div>
    </div>
    <div class="mfoot" style="justify-content:space-between">
      <span id="bulk-status" style="font-size:12px;color:var(--text3)"></span>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="closeM('bulk-modal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="saveBulkEntry()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
